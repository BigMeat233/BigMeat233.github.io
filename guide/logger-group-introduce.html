<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>日志输出组 | Corejs Doc</title>
    <meta name="generator" content="VuePress 1.4.1">
    <link rel="icon" href="/images/logo.png">
    <meta name="description" content="Node-Corejs文档">
    <link rel="preload" href="/assets/css/0.styles.21d739ca.css" as="style"><link rel="preload" href="/assets/js/app.3dfa1ee5.js" as="script"><link rel="preload" href="/assets/js/2.6fef8c05.js" as="script"><link rel="preload" href="/assets/js/16.d73b1721.js" as="script"><link rel="prefetch" href="/assets/js/10.b204632a.js"><link rel="prefetch" href="/assets/js/11.56c9accf.js"><link rel="prefetch" href="/assets/js/12.75ea1064.js"><link rel="prefetch" href="/assets/js/13.6182130e.js"><link rel="prefetch" href="/assets/js/14.10b2dc1a.js"><link rel="prefetch" href="/assets/js/15.104771fa.js"><link rel="prefetch" href="/assets/js/17.125936a0.js"><link rel="prefetch" href="/assets/js/18.cc2998e3.js"><link rel="prefetch" href="/assets/js/19.9d534a93.js"><link rel="prefetch" href="/assets/js/20.9002e28b.js"><link rel="prefetch" href="/assets/js/21.b596d1ee.js"><link rel="prefetch" href="/assets/js/3.78a772bd.js"><link rel="prefetch" href="/assets/js/4.3731c432.js"><link rel="prefetch" href="/assets/js/5.92ea34d1.js"><link rel="prefetch" href="/assets/js/6.d5dbca58.js"><link rel="prefetch" href="/assets/js/7.7184b924.js"><link rel="prefetch" href="/assets/js/8.ca7eb9f5.js"><link rel="prefetch" href="/assets/js/9.5d8d2bd5.js">
    <link rel="stylesheet" href="/assets/css/0.styles.21d739ca.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/images/logo.png" alt="Corejs Doc" class="logo"> <span class="site-name can-hide">Corejs Doc</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/guide/" class="nav-link router-link-active">
  教程
</a></div><div class="nav-item"><a href="/api/" class="nav-link">
  API
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/guide/" class="nav-link router-link-active">
  教程
</a></div><div class="nav-item"><a href="/api/" class="nav-link">
  API
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>基础</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/" class="sidebar-link">介绍</a></li><li><a href="/guide/getting-started.html" class="sidebar-link">快速上手</a></li><li><a href="/guide/web-service.html" class="sidebar-link">Web服务</a></li><li><a href="/guide/request-handler.html" class="sidebar-link">请求处理</a></li><li><a href="/guide/log-collectting.html" class="sidebar-link">日志收集</a></li><li><a href="/guide/logger-introduce.html" class="sidebar-link">日志输出器</a></li><li><a href="/guide/logger-group-introduce.html" class="active sidebar-link">日志输出组</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/logger-group-introduce.html#行为控制" class="sidebar-link">行为控制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/logger-group-introduce.html#输出器构建" class="sidebar-link">输出器构建</a></li><li class="sidebar-sub-header"><a href="/guide/logger-group-introduce.html#输出器启动" class="sidebar-link">输出器启动</a></li><li class="sidebar-sub-header"><a href="/guide/logger-group-introduce.html#输出器关闭" class="sidebar-link">输出器关闭</a></li></ul></li><li class="sidebar-sub-header"><a href="/guide/logger-group-introduce.html#loggercore" class="sidebar-link">LoggerCore</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/logger-group-introduce.html#配置说明" class="sidebar-link">配置说明</a></li><li class="sidebar-sub-header"><a href="/guide/logger-group-introduce.html#配置参数" class="sidebar-link">配置参数</a></li><li class="sidebar-sub-header"><a href="/guide/logger-group-introduce.html#运行原理" class="sidebar-link">运行原理</a></li><li class="sidebar-sub-header"><a href="/guide/logger-group-introduce.html#创建输出组" class="sidebar-link">创建输出组</a></li></ul></li><li class="sidebar-sub-header"><a href="/guide/logger-group-introduce.html#基础输出组" class="sidebar-link">基础输出组</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/logger-group-introduce.html#运行原理-2" class="sidebar-link">运行原理</a></li><li class="sidebar-sub-header"><a href="/guide/logger-group-introduce.html#定制输出组" class="sidebar-link">定制输出组</a></li></ul></li></ul></li><li><a href="/guide/cluster-manager.html" class="sidebar-link">多进程架构</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>进阶</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/handler-manager.html" class="sidebar-link">Handler管理</a></li><li><a href="/guide/dynamic-middleware.html" class="sidebar-link">动态中间件</a></li><li><a href="/guide/static-resource.html" class="sidebar-link">静态资源</a></li><li><a href="/guide/logger-customizing.html" class="sidebar-link">自定义输出器</a></li><li><a href="/guide/logger-group-customizing.html" class="sidebar-link">自定义输出组</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="日志输出组"><a href="#日志输出组" class="header-anchor">#</a> 日志输出组</h1> <div class="custom-block tip"><p class="custom-block-title">说明</p> <p>本章中使用的宏变量存储在<code>Core.Macros</code>中。</p></div> <p><strong>日志输出组</strong>提供了将一个或多个<a href="/guide/logger-introduce">日志输出器</a>进行组合的能力。在本章中，我们将讨论<strong>日志输出组</strong>的使用方式。</p> <p>我们已经知道，<strong>日志输出组</strong>无法通过实例化直接创建实例，而是依赖<a href="#loggercore">LoggerCore</a>执行<code>createGroupLogger()</code>间接执行实例化。</p> <div class="custom-block tip"><p class="custom-block-title">说明</p> <p>在设计上，<strong>日志输出组</strong>使用了典型的工厂模式，即<a href="#loggercore">LoggerCore</a>是生产<strong>日志输出组</strong>的工厂。</p> <p>因此，我们在使用<strong>日志输出组</strong>进行组合日志输出需要：</p> <ul><li><p>将需要组合的<a href="/guide/logger-introduce">日志输出器</a>组成<strong>LoggerCore</strong>的配置参数创建<strong>LoggerCore</strong>实例。</p></li> <li><p>使用<strong>LoggerCore</strong>实例执行<code>createGroupLogger()</code>并传入期望的<strong>日志输出组</strong>类型和配置参数，即可得到对应的<strong>日志输出组</strong>实例。</p></li></ul></div> <h2 id="行为控制"><a href="#行为控制" class="header-anchor">#</a> 行为控制</h2> <p>在引入了<a href="#loggercore">LoggerCore</a>和<strong>日志输出组</strong>后，我们无法直接触发<strong>日志输出组</strong>组合的<a href="/guide/logger-introduce">日志输出器</a>的构建、启动和关闭动作。而是在实例化<a href="#loggercore">LoggerCore</a>使用的配置参数中指定这些动作的触发方式，使<strong>LoggerCore</strong>和<strong>日志输出组</strong>在恰当的时间点自动执行这些动作以满足日志收集的场景。</p> <h3 id="输出器构建"><a href="#输出器构建" class="header-anchor">#</a> 输出器构建</h3> <p>我们在<a href="#loggercore">LoggerCore</a>构建时的配置参数中指定每个<a href="/guide/logger-introduce">日志输出器</a>的<code>buildTrigger</code>以控制何时创建这些<strong>日志输出器</strong>的实例：</p> <ul><li><p><strong><code>init</code></strong>：在<strong>LoggerCore</strong>实例化时触发<strong>日志输出器</strong>的构建动作。通常，持续型输出器使用此方式触发构建，比如：<a href="/guide/logger-introduce.html#日期输出器">日期输出器</a>。</p></li> <li><p><strong><code>create</code></strong>：在<strong>日志输出组</strong>实例化时触发<strong>日志输出器</strong>的构建动作，即：<strong>LoggerCore</strong>实例执行<code>createGroupLogger()</code>时。通常，临时型输出器使用此方式触发构建，比如：<a href="/guide/logger-introduce.html#文件输出器">文件输出器</a>。</p></li></ul> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>原则上，<strong>LoggerCore</strong>实例化动作仅执行一次。因此，我们可以将期望被<strong>LoggerCore</strong>创建的所有<strong>日志输出组</strong>实例共享的<strong>日志输出器</strong>使用<code>init</code>方式触发构建。</p> <p>比如对一些频次型业务产生的日志进行收集时，我们可能希望将每次业务执行时的基础信息通过相同的<strong>日志输出器</strong>进行收集，而每次业务执行链路产生的日志使用不同的<strong>日志输出器</strong>收集。此时，我们可以：</p> <ul><li><p>指定<strong>日志输出组</strong>共享的<strong>日志输出器</strong>使用<code>init</code>方式触发构建。</p></li> <li><p>指定<strong>日志输出组</strong>非共享的<strong>日志输出器</strong>使用<code>create</code>方式触发构建。</p></li> <li><p>每次业务执行时，使用<strong>LoggerCore</strong>实例执行<code>createGroupLogger()</code>创建新的<strong>日志输出组</strong>实例用于链路中的日志收集。</p></li></ul></div> <h3 id="输出器启动"><a href="#输出器启动" class="header-anchor">#</a> 输出器启动</h3> <p>同样，我们可以在<a href="#loggercore">LoggerCore</a>构建时的配置参数中指定每个<a href="/guide/logger-introduce">日志输出器</a>的<code>startTrigger</code>以控制何时启动这些<strong>日志输出器</strong>的实例：</p> <ul><li><p><strong><code>none</code></strong>：<strong>LoggerCore</strong>和<strong>日志输出组</strong>不执<strong>日志输出器</strong>的启动动作。通常，支持自动启动的输出器使用此方式触发启动，比如：<a href="/guide/logger-introduce.html#日期输出器">日期输出器</a>、自动模式下的<a href="/guide/logger-introduce.html#文件输出器">文件输出器</a>。</p></li> <li><p><strong><code>normal</code></strong>：在<strong>日志输出组</strong>实例执行<code>start()</code>时触发<strong>日志输出器</strong>的启动动作，即：<strong>日志输出器</strong>伴随<strong>日志输出组</strong>启动。通常，不支持自动启动的输出器使用此方式触发启动，比如：手动模式下的<a href="/guide/logger-introduce.html#文件输出器">文件输出器</a>。</p></li></ul> <h3 id="输出器关闭"><a href="#输出器关闭" class="header-anchor">#</a> 输出器关闭</h3> <p>同样，我们可以在<a href="#loggercore">LoggerCore</a>构建时的配置参数中指定每个<a href="/guide/logger-introduce">日志输出器</a>的<code>closeTrigger</code>以控制何时关闭这些<strong>日志输出器</strong>的实例：</p> <ul><li><p><strong><code>none</code></strong>：<strong>LoggerCore</strong>和<strong>日志输出组</strong>不执<strong>日志输出器</strong>的关闭动作。通常，支持自动关闭的输出器使用此方式触发关闭，比如：自动模式下的<a href="/guide/logger-introduce.html#文件输出器">文件输出器</a>。</p></li> <li><p><strong><code>normal</code></strong>：在<strong>日志输出组</strong>实例执行<code>close()</code>时触发<strong>日志输出器</strong>的关闭动作，即：<strong>日志输出器</strong>伴随<strong>日志输出组</strong>关闭。通常，不支持自动关闭的输出器使用此方式触发关闭，比如：<a href="/guide/logger-introduce.html#日期输出器">日期输出器</a>、手动模式下的<a href="/guide/logger-introduce.html#文件输出器">文件输出器</a>。</p></li></ul> <h2 id="loggercore"><a href="#loggercore" class="header-anchor">#</a> LoggerCore</h2> <p>我们已经知道，<strong>LoggerCore</strong>是生产<strong>日志输出组</strong>的工厂。</p> <p>通常，我们把<strong>LoggerCore</strong>实例在相同的日志收集场景中共享。在业务执行时，使用<code>createGroupLogger()</code>创建<strong>日志输出组</strong>实例用于跟踪业务链路中产生的日志。</p> <hr> <p><strong>LoggerCore</strong>实例创建<strong>日志输出组</strong>实例实际上执行了两个动作：</p> <ol><li><p><strong>LoggerCore</strong>实例根据实例化时应用的配置参数，创建需要组合的<a href="/guide/logger-introduce">日志输出器</a>实例并组成待植入<strong>日志输出组</strong>实例的<strong>日志输出器实例列表</strong>。</p></li> <li><p>实例化<code>createGroupLogger()</code>指定的<strong>日志输出组</strong>，得到对应的<strong>日志输出组</strong>实例。<strong>日志输出组</strong>实例化时会应用①中构造的<strong>日志输出器实例列表</strong>。</p></li></ol> <div class="custom-block tip"><p class="custom-block-title">说明</p> <p><strong>日志输出器实例列表</strong>中的元素其实并不仅仅是<strong>日志输出器</strong>实例本身，而是一个包含了<strong>日志输出器</strong>的行为触发方式的<code>Object</code>，其结构为：</p> <ul><li><p><strong><code>logger</code></strong>：<strong>日志输出器</strong>实例。</p></li> <li><p><strong><code>startTrigger</code></strong>：<strong>日志输出器</strong>的启动触发方式。</p></li> <li><p><strong><code>closeTrigger</code></strong>：<strong>日志输出器</strong>的关闭触发方式。</p></li></ul> <p><strong>日志输出组</strong>将根据<strong>行为触发方式</strong>在恰当的时间点执行<strong>日志输出器</strong>实例的相关动作。</p></div> <h3 id="配置说明"><a href="#配置说明" class="header-anchor">#</a> 配置说明</h3> <p>通常，实例化<strong>LoggerCore</strong>需要使用由<strong>标识ID</strong>、<strong>输出器基础配置</strong>和<strong>输出器配置列表</strong>构成的配置对象，即：<code>{ id, env, level, params, loggers }</code>。</p> <ul><li><code>id</code>：<strong>LoggerCore</strong>的唯一标识，默认值为<code>`LoggerCore_${generateRandomString(6, 'uln')}`</code>。</li></ul> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>我们可以通过在应用程序中使用唯一的<code>id</code>标识和存储<strong>LoggerCore</strong>实例以实现在相同日志收集场景中共享<strong>LoggerCore</strong>实例。</p></div> <ul><li><p><code>env</code>：<strong>LoggerCore</strong>的运行环境/<strong>日志输出器</strong>的基础运行环境，默认值为<code>BASE_LOGGER_DEVELOPMENT_ENVIRONMENT</code>。</p> <p>需要注意的是，<strong>运行环境</strong>将影响<strong>LoggerCore</strong>的行为：</p> <ul><li><p>当运行环境为<code>BASE_LOGGER_DEVELOPMENT_ENVIRONMENT</code>时，<strong>LoggerCore</strong>创建<strong>日志输出器</strong>实例时将忽略配置对象中指定的<strong>输出器配置列表</strong>。</p></li> <li><p>当运行环境不为<code>BASE_LOGGER_DEVELOPMENT_ENVIRONMENT</code>时，<strong>LoggerCore</strong>创建<strong>日志输出器</strong>实例时将应用配置对象中实际指定的<strong>输出器配置列表</strong>。</p></li></ul> <div class="custom-block tip"><p class="custom-block-title">说明</p> <p>当运行环境为<code>BASE_LOGGER_DEVELOPMENT_ENVIRONMENT</code>时，<strong>LoggerCore</strong>将不再使用配置对象中指定的<strong>输出器配置列表</strong>创建<strong>日志输出器</strong>实例，而是使用一个<a href="/guide/logger-introduce.html#基础输出器">基础输出器</a>将日志单点输出至控制台，其触发方式为：</p> <ul><li><p><strong>构建触发方式</strong>：<code>init</code>。</p></li> <li><p><strong>启动触发方式</strong>：<code>none</code>。</p></li> <li><p><strong>关闭触发方式</strong>：<code>none</code>。</p></li></ul></div> <hr> <p>另外，此配置将作为在<strong>输出器配置列表</strong>中指定<strong>日志输出器</strong>运行环境<code>env</code>时的默认值：</p> <ul><li><p>未指定<strong>日志输出器</strong>的<code>env</code>时，使用此配置。</p></li> <li><p>指定了<strong>日志输出器</strong>的<code>env</code>时，使用实际配置。</p></li></ul></li> <li><p><code>level</code>：<strong>日志输出器</strong>的基础最小日志输出等级的名称或别名。</p> <p>与<a href="/guide/logger-introduce">日志输出器</a>相同，此配置的默认值依赖于当前<strong>LoggerCore</strong>的<strong>运行环境</strong>：</p> <ul><li><p>当运行环境为<code>BASE_LOGGER_DEVELOPMENT_ENVIRONMENT</code>时，默认值为：<code>all</code>。</p></li> <li><p>当运行环境不为<code>BASE_LOGGER_DEVELOPMENT_ENVIRONMENT</code>时，默认值为：<code>error</code>。</p></li></ul> <p>此配置的意义在于，将作为在<strong>输出器配置列表</strong>中指定<strong>日志输出器</strong>最小日志输出等级<code>level</code>时的默认值：</p> <ul><li><p>未指定<strong>日志输出器</strong>的<code>level</code>时，使用此配置。</p></li> <li><p>指定了<strong>日志输出器</strong>的<code>level</code>时，使用实际配置。</p></li></ul></li> <li><p><code>params</code>：<strong>日志输出器</strong>的基础功能配置参数。</p></li> <li><p><code>loggers</code>：<strong>日志输出器</strong>的配置列表，其元素结构为：<code>{ type, buildTrigger, startTrigger, closeTrigger, env, level, params }</code>。</p> <ul><li><p><code>type</code>：<strong>日志输出器</strong>的类型，可以使用Corejs内置的<strong>日志输出器</strong>或<a href="/guide/logger-customizing.html">自定义输出器</a>，默认值为<code>null</code>。</p> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p><strong>LoggerCore</strong>创建<strong>日志输出器</strong>实例时将对使用的<code>type</code>进行校验。如果指定了未继承自<code>Core.BaseLogger</code>的<strong>自定义输出器</strong>时，将认为<strong>日志输出器</strong>的类型无效，不再执行实际构建动作。</p></div></li> <li><p><code>buildTrigger</code>：<strong>日志输出器</strong>的<strong>构建触发方式</strong>，默认值为<code>'init'</code>。</p></li> <li><p><code>startTrigger</code>：<strong>日志输出器</strong>的<strong>启动触发方式</strong>，默认值为<code>'none'</code>。</p></li> <li><p><code>closeTrigger</code>：<strong>日志输出器</strong>的<strong>关闭触发方式</strong>，默认值为<code>'none'</code>。</p></li></ul> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>关于<strong>日志输出器</strong>的行为触发方式，我们可以参考<a href="#%E8%A1%8C%E4%B8%BA%E6%8E%A7%E5%88%B6">行为控制</a>一节。</p></div> <ul><li><p><code>env</code>：<strong>日志输出器</strong>的<strong>运行环境</strong>，默认值为<strong>LoggerCore</strong>的<strong>运行环境</strong>。</p></li> <li><p><code>level</code>：<strong>日志输出器</strong>最小日志输出等级的名称或别名，默认值为<strong>LoggerCore</strong>的最小日志输出等级名称或别名。</p></li> <li><p><code>params</code>：<strong>日志输出器</strong>的功能配置参数。</p></li></ul> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>关于<strong>日志输出器</strong>的<strong>运行环境</strong>、<strong>最小输出等级</strong>和<strong>功能配置参数</strong>，我们可以参考<strong>日志输出器</strong>的<a href="/guide/logger-introduce.html#输出器配置">功能配置</a>一节。</p></div></li></ul> <h3 id="配置参数"><a href="#配置参数" class="header-anchor">#</a> 配置参数</h3> <p>在<strong>LoggerCore</strong>创建<strong>日志输出器</strong>实例时，应用的<strong>配置参数</strong>通过将<strong>个性化配置参数</strong>合并至<strong>默认配置参数</strong>生成：</p> <ul><li><p><strong>个性化配置参数</strong>即是在<strong>输出器配置列表</strong>对<strong>日志输出器</strong>指定的<strong>配置参数</strong>。</p></li> <li><p><strong>默认配置参数</strong>可能由以下两个部分组成：</p> <ol><li><p><strong>LoggerCore</strong>实例化时指定的<code>env</code>、<code>level</code>和<code>params</code>组成的<strong>配置参数</strong>。</p></li> <li><p><strong>LoggerCore</strong>实例执行<code>createGroupLogger()</code>时传入的<strong>配置参数</strong>。</p></li></ol></li></ul> <h4 id="默认配置参数"><a href="#默认配置参数" class="header-anchor">#</a> 默认配置参数</h4> <hr> <ul><li><p><strong>使用<code>init</code>触发创建行为的日志输出器</strong>，其实例化时使用的<strong>默认配置参数</strong>将仅由<strong>LoggerCore</strong>实例化时指定的<code>env</code>、<code>level</code>和<code>params</code>组成。</p></li> <li><p><strong>使用<code>create</code>触发创建行为的日志输出器</strong>，对于其使用的<strong>默认配置参数</strong>：</p> <ol><li><p>使用<code>Object.assign()</code>将<code>createGroupLogger()</code>时传入<strong>配置参数</strong>的功能配置参数<code>params</code>与<strong>LoggerCore</strong>实例化时指定的基础功能配置参数<code>params</code>合并，得到<code>{ params }</code>。</p></li> <li><p>使用<code>Object.assign()</code>将<code>createGroupLogger()</code>时传入<strong>配置参数</strong>的<strong>运行环境</strong>与<strong>最小输出等级</strong>组成<code>{ env, level }</code>并与<strong>LoggerCore</strong>实例化时指定<code>env</code>和<code>level</code>合并，得到<code>{ env, level }</code>。</p></li> <li><p>使用<code>Object.assign()</code>合并①和②得到<strong>默认配置参数</strong>。</p></li></ol></li></ul> <h4 id="应用配置参数"><a href="#应用配置参数" class="header-anchor">#</a> 应用配置参数</h4> <hr> <p>在创建<strong>日志输出器</strong>实例时，<strong>LoggerCore</strong>使用与<a href="#%E9%BB%98%E8%AE%A4%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0">默认配置参数</a>类似的方式合并<strong>个性化配置参数</strong>和<strong>默认配置参数</strong>生成最终应用于<strong>日志输出器</strong>的配置参数。因此，配置参数的优先级顺序从高到低依次为：</p> <ul><li><p><strong>输出器配置列表</strong>中指定的<strong>配置参数</strong>。</p></li> <li><p><code>createGroupLogger()</code>时指定的<strong>配置参数</strong>。</p></li> <li><p>在<strong>LoggerCore</strong>实例化参数中指定的<strong>配置参数</strong>。</p></li></ul> <p>在默认的<strong>配置参数</strong>应用规则无法满足实际需求时，我们可以修改<strong>LoggerCore</strong>实例的<code>onBuildLogger</code>属性以定制<strong>日志输出器</strong>的创建行为，具体将在<a href="#%E8%BF%90%E8%A1%8C%E5%8E%9F%E7%90%86">运行原理</a>一节中讨论。</p> <h3 id="运行原理"><a href="#运行原理" class="header-anchor">#</a> 运行原理</h3> <p>我们已经知道，<strong>LoggerCore</strong>实例将在执行<code>createGroupLogger()</code>时创建<strong>日志输出组</strong>实例并向其中植入<strong>日志输出器实例列表</strong>。于是，小朋友你是否有很多问号：</p> <ul><li><p><strong>日志输出器</strong>实例如何创建？</p></li> <li><p><strong>日志输出器</strong>实例何时创建？</p></li></ul> <p>在本节中，我们将围绕这两个问题讨论<strong>LoggerCore</strong>的运行原理。</p> <hr> <p>对于<strong>日志输出器实例如何创建</strong>，答案非常简单：<strong>LoggerCore</strong>将在需要创建<strong>输出器配置列表</strong>某个<strong>日志输出器</strong>时，提取其在<strong>输出器配置列表</strong>指定的配置参数并调用实例方法<code>onBuildLogger()</code>。</p> <p><code>onBuildLogger()</code>接收三个参数用于创建<strong>日志输出器</strong>实例：</p> <ul><li><p><strong><code>type</code></strong>：<strong>日志输出器</strong>的类型。</p></li> <li><p><strong><code>loggerConfigs</code></strong>：在<strong>输出器配置列表</strong>中指定的<strong>个性化配置参数</strong>。</p></li> <li><p><strong><code>defaultConfigs</code></strong>：<strong>LoggerCore</strong>自动应用的<a href="#%E9%BB%98%E8%AE%A4%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0">默认配置参数</a>。</p></li></ul> <p>举一个🌰，有这样一个<strong>LoggerCore</strong>：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> Core <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'node-corejs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> loggerCore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Core<span class="token punctuation">.</span>LoggerCore</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  env<span class="token operator">:</span> <span class="token string">'prod'</span><span class="token punctuation">,</span>
  level<span class="token operator">:</span> <span class="token string">'infos'</span><span class="token punctuation">,</span>
  params<span class="token operator">:</span> <span class="token punctuation">{</span> sourcePath<span class="token operator">:</span> <span class="token string">'./testlogs'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  loggers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
    type<span class="token operator">:</span> Core<span class="token punctuation">.</span>FileLogger<span class="token punctuation">,</span>
    buildTrigger<span class="token operator">:</span> <span class="token string">'create'</span><span class="token punctuation">,</span>
    startTrigger<span class="token operator">:</span> <span class="token string">'normal'</span><span class="token punctuation">,</span>
    closeTrigger<span class="token operator">:</span> <span class="token string">'normal'</span><span class="token punctuation">,</span>
    level<span class="token operator">:</span> <span class="token string">'error'</span><span class="token punctuation">,</span>
    params<span class="token operator">:</span> <span class="token punctuation">{</span> auto<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> filePrefix<span class="token operator">:</span> <span class="token string">'FileLogger_1'</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>在创建<strong>日志输出组</strong>时使用了：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>loggerCore<span class="token punctuation">.</span><span class="token function">createGroupLogger</span><span class="token punctuation">(</span><span class="token punctuation">{</span> level<span class="token operator">:</span> <span class="token string">'all'</span><span class="token punctuation">,</span> params<span class="token operator">:</span> <span class="token punctuation">{</span> fileName<span class="token operator">:</span> <span class="token string">'LogFile'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>那么，<strong>LoggerCore</strong>调用<code>onBuildLogger()</code>时带入的参数为：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>type <span class="token operator">=</span> Core<span class="token punctuation">.</span>FileLogger<span class="token punctuation">;</span>

loggerConfigs <span class="token operator">=</span> <span class="token punctuation">{</span> level<span class="token operator">:</span> <span class="token string">'error'</span><span class="token punctuation">,</span> params<span class="token operator">:</span> <span class="token punctuation">{</span> auto<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> filePrefix<span class="token operator">:</span> <span class="token string">'FileLogger_1'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

defaultConfigs <span class="token operator">=</span> <span class="token punctuation">{</span> env<span class="token operator">:</span> <span class="token string">'prod'</span><span class="token punctuation">,</span> level<span class="token operator">:</span> <span class="token string">'all'</span><span class="token punctuation">,</span> params<span class="token operator">:</span> <span class="token punctuation">{</span> sourcePath<span class="token operator">:</span> <span class="token string">'./testlogs'</span><span class="token punctuation">,</span> fileName<span class="token operator">:</span> <span class="token string">'LogFile'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>接下来，让我们看一看<code>onBuildLogger()</code>的默认合并<strong>个性化配置参数</strong>和<strong>默认配置参数</strong>的实现：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token function">onBuildLogger</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> loggerConfigs<span class="token punctuation">,</span> defaultConfigs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 将个性化功能配置合并至默认功能配置</span>
  <span class="token keyword">const</span> params <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> defaultConfigs<span class="token punctuation">.</span>params<span class="token punctuation">,</span> loggerConfigs<span class="token punctuation">.</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 将个性化配置合并至默认配置并合并功能配置</span>
  <span class="token keyword">const</span> configs <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> defaultConfigs<span class="token punctuation">,</span> loggerConfigs<span class="token punctuation">,</span> <span class="token punctuation">{</span> params <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 执行输出器的实例化</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">type</span><span class="token punctuation">(</span>configs<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>因此，我们可以通过修改<strong>LoggerCore</strong>实例的<code>onBuildLogger</code>属性进行更改以变更默认的<strong>日志输出器</strong>创建行为。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> Core <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'node-corejs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 创建LoggerCore实例</span>
<span class="token keyword">const</span> loggerCore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Core<span class="token punctuation">.</span>LoggerCore</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  env<span class="token operator">:</span> <span class="token string">'prod'</span><span class="token punctuation">,</span>
  level<span class="token operator">:</span> <span class="token string">'infos'</span><span class="token punctuation">,</span>
  params<span class="token operator">:</span> <span class="token punctuation">{</span> sourcePath<span class="token operator">:</span> <span class="token string">'./testlogs'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  loggers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
    type<span class="token operator">:</span> Core<span class="token punctuation">.</span>FileLogger<span class="token punctuation">,</span>
    buildTrigger<span class="token operator">:</span> <span class="token string">'create'</span><span class="token punctuation">,</span>
    startTrigger<span class="token operator">:</span> <span class="token string">'normal'</span><span class="token punctuation">,</span>
    closeTrigger<span class="token operator">:</span> <span class="token string">'normal'</span><span class="token punctuation">,</span>
    level<span class="token operator">:</span> <span class="token string">'error'</span><span class="token punctuation">,</span>
    params<span class="token operator">:</span> <span class="token punctuation">{</span> 
      auto<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> 
      filePrefix<span class="token operator">:</span> <span class="token string">'FileLogger_1'</span><span class="token punctuation">,</span>
      filePrefixAsFileName<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 必须在createGroupLogger()前修改onBuildLogger()</span>
loggerCore<span class="token punctuation">.</span><span class="token function-variable function">onBuildLogger</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> loggerConfigs<span class="token punctuation">,</span> defaultConfigs</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 在文件名中附加日志输出的次数</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> fileName<span class="token punctuation">,</span> count <span class="token punctuation">}</span> <span class="token operator">=</span> defaultConfigs<span class="token punctuation">.</span>params<span class="token punctuation">;</span>
  <span class="token comment">// 应用至原有的参数合并逻辑中</span>
  <span class="token keyword">const</span> params <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> defaultConfigs<span class="token punctuation">.</span>params<span class="token punctuation">,</span> loggerConfigs<span class="token punctuation">.</span>params<span class="token punctuation">,</span> <span class="token punctuation">{</span> fileName<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fileName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> configs <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> defaultConfigs<span class="token punctuation">,</span> loggerConfigs<span class="token punctuation">,</span> <span class="token punctuation">{</span> params <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">type</span><span class="token punctuation">(</span>configs<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 进行日志输出</span>
<span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  count <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token comment">// 在创建日志输出组时传入count</span>
  <span class="token keyword">const</span> logger <span class="token operator">=</span> loggerCore<span class="token punctuation">.</span><span class="token function">createGroupLogger</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    params<span class="token operator">:</span> <span class="token punctuation">{</span> count<span class="token punctuation">,</span> fileName<span class="token operator">:</span> <span class="token string">'LogFile'</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  logger<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  logger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'一个🌰日志'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  logger<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><hr> <p>对于<strong>日志输出器实例何时创建</strong>，<strong>LoggerCore</strong>将根据在<strong>输出器配置列表</strong>中指定的<strong>构建触发方式</strong>决定创建<strong>日志输出器</strong>实例的时间点。</p> <h4 id="实例化阶段"><a href="#实例化阶段" class="header-anchor">#</a> 实例化阶段</h4> <hr> <ol><li><p>根据<strong>构建触发方式</strong>对<strong>输出器配置列表</strong>中的配置对象进行分类。</p></li> <li><p>提取分类结果中使用<code>init</code>方式触发构建的配置对象，逐个使用配置对象内指定的配置执行<code>onBuildLogger()</code>创建对应的<strong>日志输出器</strong>实例并存储在实例属性<code>_baseLoggerObjects</code>中。</p></li></ol> <h4 id="执行creategrouplogger"><a href="#执行creategrouplogger" class="header-anchor">#</a> 执行<code>createGroupLogger()</code></h4> <hr> <ol><li><p>根据<code>createGroupLogger()</code>传入的<strong>配置参数</strong>和<strong>LoggerCore</strong>实例的<strong>配置参数</strong>生成<strong>默认配置参数</strong>。</p></li> <li><p>提取并迭代分类结果中使用<code>create</code>方式触发构建的配置对象，使用配置对象内指定的配置参数和<strong>默认配置参数</strong>执行<code>onBuildLogger()</code>创建对应的<strong>日志输出器</strong>实例。</p></li> <li><p>合并<strong>LoggerCore</strong>实例属性<code>_baseLoggerObjects</code>中存储的<strong>日志输出器</strong>实例和①中创建的<strong>日志输出器</strong>实例组成待植入<strong>日志输出组</strong>实例的<strong>日志输出器实例列表</strong>。</p></li> <li><p>根据<code>createGroupLogger()</code>传入的<strong>日志输出组类型</strong>，创建对应的<strong>日志输出组</strong>实例并向其植入②中得到的<strong>日志输出器实例列表</strong>。</p></li></ol> <h3 id="创建输出组"><a href="#创建输出组" class="header-anchor">#</a> 创建输出组</h3> <p>在实现细节上，<strong>日志输出组</strong>继承自<a href="/guide/logger-introduce.html#基础输出器">基础输出器</a>，本质上是一个<strong>高阶日志输出器</strong>。虽然目前没有开放指定<strong>日志输出组</strong>的<strong>功能配置参数</strong>的相关API，我们可以通过在启动<strong>日志输出组</strong>之前修改其实例属性以控制其表现行为，目前支持修改<strong>日志输出组</strong>的以下属性：</p> <ul><li><code>_errorHandler</code></li> <li><code>_checkStateInLog</code></li> <li><code>_checkStateInStart</code></li> <li><code>_checkStateInClose</code></li></ul> <p>我们可以在<a href="/guide/logger-introduce.html#基础输出器">基础输出器</a>的<a href="/guide/logger-introduce.html#功能参数">功能参数</a>一节中根据其同名的<strong>功能配置参数</strong>了解这些实例属性的作用。</p> <hr> <p><code>createGroupLogger()</code>支持多种调用方式：</p> <ul><li><strong><code>createGroupLogger()</code></strong>：不指定配置参数创建<a href="#%E5%9F%BA%E7%A1%80%E8%BE%93%E5%87%BA%E7%BB%84">基础输出组</a>的实例。</li> <li><strong><code>createGroupLogger(type)</code></strong>：不指定配置参数创建指定的<strong>日志输出组</strong>的实例。</li> <li><strong><code>createGroupLogger(configs)</code></strong>：使用指定配置参数创建<a href="#%E5%9F%BA%E7%A1%80%E8%BE%93%E5%87%BA%E7%BB%84">基础输出组</a>的实例。</li> <li><strong><code>createGroupLogger(type, configs)</code></strong>：使用指定配置参数创建指定的<strong>日志输出组</strong>的实例。</li></ul> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p><code>createGroupLogger()</code>执行过程中将对使用的<strong>日志输出组</strong>类型进行校验。出于保证应用程序的可用性考虑，如果使用了无效的<strong>日志输出组</strong>类型（即：非继承自<a href="#%E5%9F%BA%E7%A1%80%E8%BE%93%E5%87%BA%E7%BB%84">基础输出组</a>的<a href="/guide/logger-group-customizing.html">自定义输出组</a>），将默认创建<strong>基础输出组</strong>的实例。</p></div> <hr> <p>接下来，我们使用<strong>LoggerCore</strong>实现一个复杂的组合日志输出场景：</p> <p><strong>目标1</strong>：</p> <ul><li><p>保留最近5个归档日期内的日志。</p></li> <li><p>将每秒内产生的日志归档至同一<strong>日志文件</strong>，超出<code>1KB</code>时自动分割。</p></li> <li><p><strong>日志文件</strong>按照<strong>归档前缀</strong>存储，且<strong>日志文件名</strong>中不展示<strong>归档前缀</strong>。</p></li></ul> <p><strong>目标2</strong>：</p> <ul><li><p>保留最近10秒内的日志。</p></li> <li><p><strong>日志文件名</strong>中展示<strong>归档时间</strong>，但不展示<strong>归档前缀</strong>。</p></li> <li><p><strong>日志文件</strong>按照<strong>归档前缀</strong>存储，并将每5秒内产生的<strong>日志文件</strong>归档至同一文件。</p></li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> Core <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'node-corejs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 创建LoggerCore</span>
<span class="token keyword">const</span> loggerCore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Core<span class="token punctuation">.</span>LoggerCore</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  env<span class="token operator">:</span> <span class="token string">'prod'</span><span class="token punctuation">,</span>
  level<span class="token operator">:</span> <span class="token string">'infos'</span><span class="token punctuation">,</span>
  params<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 指定统一的归档源目录</span>
    sourcePath<span class="token operator">:</span> <span class="token string">'./testlogs'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  loggers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
    <span class="token comment">// 使用共享的日期输出器实现目标1</span>
    type<span class="token operator">:</span> Core<span class="token punctuation">.</span>DateLogger<span class="token punctuation">,</span>
    buildTrigger<span class="token operator">:</span> <span class="token string">'init'</span><span class="token punctuation">,</span>                <span class="token comment">// 在LoggerCore实例化时创建日期输出器</span>
    startTrigger<span class="token operator">:</span> <span class="token string">'none'</span><span class="token punctuation">,</span>                <span class="token comment">// 日期输出器自动启动,LoggerCore无需控制其启动动作</span>
    closeTrigger<span class="token operator">:</span> <span class="token string">'none'</span><span class="token punctuation">,</span>
    params<span class="token operator">:</span> <span class="token punctuation">{</span>
      filePrefix<span class="token operator">:</span> <span class="token string">'Cycle_1s'</span><span class="token punctuation">,</span>            <span class="token comment">// 归档前缀</span>
      keepDateNum<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>                    <span class="token comment">// 保留最近5个归档日期</span>
      maxSize<span class="token operator">:</span> <span class="token number">1024</span><span class="token punctuation">,</span>                     <span class="token comment">// 最大日志文件体积为1K</span>
      dateFormat<span class="token operator">:</span> <span class="token string">'YYYY-MM-DD_HH_mm_ss'</span><span class="token punctuation">,</span> <span class="token comment">// 以秒作为归档周期</span>
      filePrefixAsFileName<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>       <span class="token comment">// 日志文件名不附加归档前缀</span>
      filePrefixAsSourcePath<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      <span class="token comment">// 在归档源目录中创建归档前缀目录</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token comment">// 使用非共享的文件输出器实现目标2</span>
    type<span class="token operator">:</span> Core<span class="token punctuation">.</span>FileLogger<span class="token punctuation">,</span>
    buildTrigger<span class="token operator">:</span> <span class="token string">'create'</span><span class="token punctuation">,</span>              <span class="token comment">// 在执行createGroupLogger()时创建新的文件输出器</span>
    startTrigger<span class="token operator">:</span> <span class="token string">'none'</span><span class="token punctuation">,</span>                <span class="token comment">// 文件输出器自动启动,LoggerCore无需控制其启动动作</span>
    closeTrigger<span class="token operator">:</span> <span class="token string">'none'</span><span class="token punctuation">,</span>                <span class="token comment">// 文件输出器自动关闭,LoggerCore无需控制其关闭动作</span>
    params<span class="token operator">:</span> <span class="token punctuation">{</span>
      filePrefix<span class="token operator">:</span> <span class="token string">'Duration_5s'</span><span class="token punctuation">,</span>         <span class="token comment">// 归档前缀</span>
      keepDateNum<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>                    <span class="token comment">// 保留最近2个归档日期，2*5=10秒</span>
      fileName<span class="token operator">:</span> <span class="token string">'_'</span><span class="token punctuation">,</span>                     <span class="token comment">// 归档文件名</span>
      filePrefixAsFileName<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>       <span class="token comment">// 日志文件名不附加归档前缀</span>
      filePrefixAsSourcePath<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      <span class="token comment">// 在归档源目录中创建归档前缀目录</span>
      dateFormat<span class="token operator">:</span> <span class="token string">'YYYY-MM-DD_HH_mm_ss'</span><span class="token punctuation">,</span> <span class="token comment">// 以秒作为归档周期</span>
      dateAsFileName<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>              <span class="token comment">// 日志文件名附加归档日期</span>
      dateAsSourcePath<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>           <span class="token comment">// 不使用归档日期分类日志文件</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> logger <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token comment">// 每五秒创建新的日志输出组</span>
<span class="token keyword">function</span> <span class="token function">refreshLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  logger <span class="token operator">&amp;&amp;</span> logger<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  logger <span class="token operator">=</span> loggerCore<span class="token punctuation">.</span><span class="token function">createGroupLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  logger<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">refreshLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">refreshLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 每100ms输出一次日志</span>
<span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  logger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'一个🌰日志'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><h2 id="基础输出组"><a href="#基础输出组" class="header-anchor">#</a> 基础输出组</h2> <p><strong>基础输出组</strong>提供了组合<strong>日志输出器</strong>并控制其行为的基本能力。因此，我们在<a href="/guide/logger-group-customizing.html">自定义输出组</a>时需要继承<strong>基础输出组</strong>。</p> <p>需要注意的是，在<strong>LoggerCore</strong>实例执行<code>createGroupLogger()</code>时，如果指定了无效的<strong>日志输出组</strong>类型将默认创建<strong>基础输出组</strong>的实例。</p> <h3 id="运行原理-2"><a href="#运行原理-2" class="header-anchor">#</a> 运行原理</h3> <p><strong>基础输出组</strong>实质上通过<a href="/guide/logger-customizing.html">自定义输出器</a>的方式实现，我们将围绕定制部分讨论<strong>基础输出组</strong>的运行原理。</p> <h4 id="构造函数"><a href="#构造函数" class="header-anchor">#</a> 构造函数</h4> <hr> <p>我们已经知道，<strong>LoggerCore</strong>在创建<strong>日志输出组</strong>时会向其中植入<strong>日志输出器实例列表</strong>。其实，<strong>日志输出组</strong>将持有其对应的<strong>LoggerCore</strong>实例的引用以维持派生关系。因此，<strong>日志输出组</strong>的构造函数接收两个参数：</p> <ul><li><p><code>loggerCore</code>：创建<strong>日志输出组</strong>的<strong>LoggerCore</strong>实例</p></li> <li><p><code>_loggerObjects</code>：<strong>日志输出器</strong>的实例列表</p></li></ul> <hr> <p>在构造阶段，<strong>日志输出组</strong>执行了三个动作：</p> <ol><li><p>将派生<strong>日志输出组</strong>的<strong>LoggerCore</strong>实例存储至实例属性<code>loggerCore</code>。</p></li> <li><p>将<strong>日志输出器实例列表</strong>作为自定义功能配置参数生成<strong>日志输出组</strong>的配置对象。</p></li> <li><p>使用②中得到的配置对象执行<code>super()</code>操作完成实例化。</p></li></ol> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>在<a href="/guide/logger-customizing.html">自定义输出器</a>时执行<code>super()</code>操作将自动引导构造流程进入初始化阶段。</p> <p>因此，为了避免执行逻辑混乱，在<strong>构造函数</strong>中仅使用功能配置参数的缓存机制存储<strong>日志输出器实例列表</strong>，而将实际的构造逻辑放在<a href="#initlogger">初始化阶段</a>。</p></div> <h4 id="initlogger"><a href="#initlogger" class="header-anchor">#</a> <code>initLogger()</code></h4> <hr> <p>在讨论<a href="#loggercore">LoggerCore</a>时我们已经提到过，<strong>日志输出器实例列表</strong>中的元素其实并不仅仅是<strong>日志输出器</strong>实例本身，而是一个包含了<strong>日志输出器</strong>的行为触发方式的<code>Object</code>。<strong>日志输出组</strong>将根据<strong>行为触发方式</strong>控制其组合的<strong>日志输出器</strong>执行启动/关闭动作。</p> <p>因此，出于性能考虑，在初始化阶段中将预先解析<strong>日志输出器实例列表</strong>提取<strong>日志输出器</strong>实例完成时空转换：</p> <ul><li><p>提取使用<code>normal</code>方式触发启动的<strong>日志输出器</strong>实例，存储在实例属性<code>_needStartLoggers</code>中。</p></li> <li><p>提取使用<code>normal</code>方式触发关闭的<strong>日志输出器</strong>实例，存储在实例属性<code>_needCloseLoggers</code>中。</p></li> <li><p>将所有<strong>日志输出器</strong>实例存储在实例属性<code>_loggers</code>中。</p></li></ul> <h4 id="onstart"><a href="#onstart" class="header-anchor">#</a> <code>onStart()</code></h4> <hr> <p>在<strong>日志输出组</strong>的<strong>启动阶段</strong>，不仅需要变更<strong>日志输出组</strong>为启动状态；对于使用<code>normal</code>作为启动触发方式的<strong>日志输出器</strong>，还需在此阶段执行启动动作。因此，在<strong>启动阶段</strong>：</p> <ol><li><p>执行<code>super.onStart()</code>尝试变更<strong>日志输出组</strong>为启动状态，如果变更状态失败则不再执行②。</p></li> <li><p>迭代实例属性<code>_needStartLoggers</code>，执行每个<strong>日志输出器</strong>实例的启动逻辑。</p></li></ol> <div class="custom-block danger"><p class="custom-block-title">注意</p> <p>指定<strong>日志输出组</strong>实例的实例属性<code>_checkStateInStart</code>将控制执行<code>super.onStart()</code>时是否在变更<strong>日志输出组</strong>启动状态前执行状态校验进而影响<strong>执行结果</strong>。</p> <p>在<strong>启动阶段</strong>的默认行为下，将通过判断<code>super.onStart()</code>的<strong>执行结果</strong>以避免<strong>日志输出器</strong>的启动逻辑多次执行。因此，请谨慎调整<code>_checkStateInStart</code>。</p></div> <h4 id="onclose"><a href="#onclose" class="header-anchor">#</a> <code>onClose()</code></h4> <hr> <p>与<strong>日志输出组</strong>的<strong>启动阶段</strong>类似，<strong>关闭阶段</strong>不仅需要变更<strong>日志输出组</strong>为关闭状态；对于使用<code>normal</code>作为关闭触发方式的<strong>日志输出器</strong>，还需在此阶段执行关闭动作。因此，在<strong>关闭阶段</strong>：</p> <ol><li><p>执行<code>super.onClose()</code>尝试变更<strong>日志输出组</strong>为关闭状态，如果变更状态失败则不再执行②。</p></li> <li><p>迭代实例属性<code>_needCloseLoggers</code>，执行每个<strong>日志输出器</strong>实例的关闭逻辑。</p></li></ol> <div class="custom-block danger"><p class="custom-block-title">注意</p> <p>指定<strong>日志输出组</strong>实例的实例属性<code>_checkStateInClose</code>将控制执行<code>super.onClose()</code>时是否在变更<strong>日志输出组</strong>启动状态前执行状态校验进而影响<strong>执行结果</strong>。</p> <p>在<strong>关闭阶段</strong>的默认行为下，将通过判断<code>super.onClose()</code>的<strong>执行结果</strong>以避免<strong>日志输出器</strong>的关闭逻辑多次执行。因此，请谨慎调整<code>_checkStateInClose</code>。</p></div> <h4 id="onlog"><a href="#onlog" class="header-anchor">#</a> <code>onLog()</code></h4> <p><strong>日志输出组</strong>本身并不产生任何日志，而是通过控制其组合的<strong>日志输出器</strong>输出日志。因此，<strong>日志输出组</strong>执行输出动作时：</p> <ol><li><p>使用<code>onCheckState(BASE_LOGGER_STATE_TYPE_CAN_LOG)</code>检测当前状态是否允许日志输出，在<strong>日志输出组</strong>当前状态不允许日志输出时将抛出异常信息且不再执行②。</p></li> <li><p>迭代实例属性<code>_loggers</code>，执行每个<strong>日志输出器</strong>实例的<code>log()</code>进行日志输出。</p></li></ol> <div class="custom-block danger"><p class="custom-block-title">注意</p> <p>指定<strong>日志输出组</strong>实例的实例属性<code>_checkStateInLog</code>将控制执行<code>onCheckState(BASE_LOGGER_STATE_TYPE_CAN_LOG)</code>时是否执行<strong>日志输出组</strong>的启动状态校验。</p> <p>在默认的输出行为中，未启动<strong>日志输出组</strong>时将拒绝执行实际输出动作以保证资源的有效性。因此，请谨慎调整<code>_checkStateInLog</code>。</p></div> <h3 id="定制输出组"><a href="#定制输出组" class="header-anchor">#</a> 定制输出组</h3> <p>在本节中，我们将定制一个简单的<strong>日志输出组</strong>用于客户端请求处理链路的日志收集：</p> <ul><li><p>记录<code>start()</code>和<code>close()</code>时间差统计处理耗时。</p></li> <li><p>执行<code>start()</code>和<code>close()</code>时自动输出开启和关闭日志。</p></li></ul> <p>首先，我们通过继承自<code>Core.GroupLogger</code>的方式实现一个自定义的<strong>日志输出组</strong>：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> Core <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'node-corejs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 自定义日志输出组
 */</span>
<span class="token keyword">class</span> <span class="token class-name">HandlerLogger</span> <span class="token keyword">extends</span> <span class="token class-name">Core<span class="token punctuation">.</span>GroupLogger</span> <span class="token punctuation">{</span>
  <span class="token function">initLogger</span><span class="token punctuation">(</span><span class="token parameter">configs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">initLogger</span><span class="token punctuation">(</span>configs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>startTime <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">onStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 尝试执行原始启动逻辑</span>
    <span class="token comment">// 在原始启动逻辑执行失败时不再执行后续逻辑</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 启动成功时记录启动时间并输出日志</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>startTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'i'</span><span class="token punctuation">,</span> <span class="token string">'处理开始'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">请求处理的开始时间:[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Core<span class="token punctuation">.</span>Utils<span class="token punctuation">.</span><span class="token function">formatDate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>startTime<span class="token punctuation">,</span> <span class="token string">'YYYY-MM-DD HH:mm:ss.SSS'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">onClose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 检测当前状态是否允许输出日志</span>
    <span class="token comment">// 允许输出日志时将记录关闭时间并输出日志</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onCheckState</span><span class="token punctuation">(</span>Core<span class="token punctuation">.</span>Macros<span class="token punctuation">.</span><span class="token constant">BASE_LOGGER_CHECK_TYPE_CAN_LOG</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> closeTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'i'</span><span class="token punctuation">,</span> <span class="token string">'处理结束'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">请求处理的结束时间:[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Core<span class="token punctuation">.</span>Utils<span class="token punctuation">.</span><span class="token function">formatDate</span><span class="token punctuation">(</span>closeTime<span class="token punctuation">,</span> <span class="token string">'YYYY-MM-DD HH:mm:ss.SSS'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">}],处理耗时:[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>closeTime <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>startTime<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]ms</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 执行原始的关闭逻辑</span>
    <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onClose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p>接下来，我们确定日志收集的场景：</p> <ul><li><p>将每次客户端请求处理链路中产生的日志输出至同一文件。</p></li> <li><p>按照<strong>请求路径</strong>和<strong>请求日期</strong>对<strong>日志文件</strong>进行分类。</p></li> <li><p><strong>日志文件名</strong>中需要保留<strong>请求方式</strong>和<strong>请求时间</strong>。</p></li> <li><p>保留最近<strong>7</strong>天的日志。</p></li></ul> <p>因此，我们可以按照以下方式创建<strong>LoggerCore</strong>：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> loggerCore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Core<span class="token punctuation">.</span>LoggerCore</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  env<span class="token operator">:</span> <span class="token string">'prod'</span><span class="token punctuation">,</span>
  level<span class="token operator">:</span> <span class="token string">'infos'</span><span class="token punctuation">,</span>
  params<span class="token operator">:</span> <span class="token punctuation">{</span> sourcePath<span class="token operator">:</span> <span class="token string">'./testlogs'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  loggers<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      type<span class="token operator">:</span> Core<span class="token punctuation">.</span>FileLogger<span class="token punctuation">,</span>
      buildTrigger<span class="token operator">:</span> <span class="token string">'create'</span><span class="token punctuation">,</span>
      startTrigger<span class="token operator">:</span> <span class="token string">'normal'</span><span class="token punctuation">,</span>
      closeTrigger<span class="token operator">:</span> <span class="token string">'normal'</span><span class="token punctuation">,</span>
      params<span class="token operator">:</span> <span class="token punctuation">{</span>
        auto<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>                  <span class="token comment">// 使用手动模式</span>
        dateFormat<span class="token operator">:</span> <span class="token string">'YYYY-MM-DD'</span><span class="token punctuation">,</span>     <span class="token comment">// 以天作为归档周期</span>
        keepDateNum<span class="token operator">:</span> <span class="token number">7</span><span class="token punctuation">,</span>               <span class="token comment">// 保留最近7个归档日期</span>
        dateAsFileName<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>        <span class="token comment">// 日志文件名不附加归档日期</span>
        dateAsSourcePath<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>       <span class="token comment">// 使用归档日期分类日志文件</span>
        filePrefixAsFileName<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>  <span class="token comment">// 日志文件名不附加归档前缀</span>
        filePrefixAsSourcePath<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 使用归档前缀分类日志文件</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>最后，让我们结合<strong>ServiceCore</strong>实现对客户端请求处理链路的日志收集：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">TestHandler</span> <span class="token keyword">extends</span> <span class="token class-name">Core<span class="token punctuation">.</span>Handler</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token function">getRoutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'/Test.do'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">initHandler</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 在初始化阶段创建日志输出组</span>
    <span class="token keyword">const</span> method <span class="token operator">=</span> req<span class="token punctuation">.</span>method<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>logger <span class="token operator">=</span> loggerCore<span class="token punctuation">.</span><span class="token function">createGroupLogger</span><span class="token punctuation">(</span>HandlerLogger<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      params<span class="token operator">:</span> <span class="token punctuation">{</span>
        filePrefix<span class="token operator">:</span> <span class="token string">'Test.do'</span><span class="token punctuation">,</span>
        fileName<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Core<span class="token punctuation">.</span>Utils<span class="token punctuation">.</span><span class="token function">formatDate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'YYYY-MM-DD_HH_mm_ss_SSS'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-[%RANDOM_FILE_NAME%]</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 启动日志输出组</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 记录链路日志</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'i'</span><span class="token punctuation">,</span> <span class="token string">'进入GET处理阶段'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token string">'Hello World'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'i'</span><span class="token punctuation">,</span> <span class="token string">'GET处理结束,向客户端返回'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">destroyHandler</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 在析构阶段关闭日志输出组</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 创建ServiceCore</span>
<span class="token keyword">const</span> serviceCore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Core<span class="token punctuation">.</span>ServiceCore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">serviceCore</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token punctuation">[</span>TestHandler<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
serviceCore<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>现在，我们可以通过访问使用<code>curl http://localhost:3000/Test.do</code>来检验实现成功啦！</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/guide/logger-introduce.html" class="prev">
        日志输出器
      </a></span> <span class="next"><a href="/guide/cluster-manager.html">
        多进程架构
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.3dfa1ee5.js" defer></script><script src="/assets/js/2.6fef8c05.js" defer></script><script src="/assets/js/16.d73b1721.js" defer></script>
  </body>
</html>
