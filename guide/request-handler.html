<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>请求处理 | Corejs Doc</title>
    <meta name="generator" content="VuePress 1.4.1">
    <link rel="icon" href="/images/logo.png">
    <meta name="description" content="Node-Corejs文档">
    <link rel="preload" href="/assets/css/0.styles.21d739ca.css" as="style"><link rel="preload" href="/assets/js/app.3dfa1ee5.js" as="script"><link rel="preload" href="/assets/js/2.6fef8c05.js" as="script"><link rel="preload" href="/assets/js/18.cc2998e3.js" as="script"><link rel="prefetch" href="/assets/js/10.b204632a.js"><link rel="prefetch" href="/assets/js/11.56c9accf.js"><link rel="prefetch" href="/assets/js/12.75ea1064.js"><link rel="prefetch" href="/assets/js/13.6182130e.js"><link rel="prefetch" href="/assets/js/14.10b2dc1a.js"><link rel="prefetch" href="/assets/js/15.104771fa.js"><link rel="prefetch" href="/assets/js/16.d73b1721.js"><link rel="prefetch" href="/assets/js/17.125936a0.js"><link rel="prefetch" href="/assets/js/19.9d534a93.js"><link rel="prefetch" href="/assets/js/20.9002e28b.js"><link rel="prefetch" href="/assets/js/21.b596d1ee.js"><link rel="prefetch" href="/assets/js/3.78a772bd.js"><link rel="prefetch" href="/assets/js/4.3731c432.js"><link rel="prefetch" href="/assets/js/5.92ea34d1.js"><link rel="prefetch" href="/assets/js/6.d5dbca58.js"><link rel="prefetch" href="/assets/js/7.7184b924.js"><link rel="prefetch" href="/assets/js/8.ca7eb9f5.js"><link rel="prefetch" href="/assets/js/9.5d8d2bd5.js">
    <link rel="stylesheet" href="/assets/css/0.styles.21d739ca.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/images/logo.png" alt="Corejs Doc" class="logo"> <span class="site-name can-hide">Corejs Doc</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/guide/" class="nav-link router-link-active">
  教程
</a></div><div class="nav-item"><a href="/api/" class="nav-link">
  API
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/guide/" class="nav-link router-link-active">
  教程
</a></div><div class="nav-item"><a href="/api/" class="nav-link">
  API
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>基础</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/" class="sidebar-link">介绍</a></li><li><a href="/guide/getting-started.html" class="sidebar-link">快速上手</a></li><li><a href="/guide/web-service.html" class="sidebar-link">Web服务</a></li><li><a href="/guide/request-handler.html" class="active sidebar-link">请求处理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/request-handler.html#介绍" class="sidebar-link">介绍</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/request-handler.html#请求路径" class="sidebar-link">请求路径</a></li><li class="sidebar-sub-header"><a href="/guide/request-handler.html#生命周期" class="sidebar-link">生命周期</a></li><li class="sidebar-sub-header"><a href="/guide/request-handler.html#中间件系统" class="sidebar-link">中间件系统</a></li><li class="sidebar-sub-header"><a href="/guide/request-handler.html#请求处理-2" class="sidebar-link">请求处理</a></li><li class="sidebar-sub-header"><a href="/guide/request-handler.html#统一处理" class="sidebar-link">统一处理</a></li></ul></li><li class="sidebar-sub-header"><a href="/guide/request-handler.html#处理流程" class="sidebar-link">处理流程</a></li><li class="sidebar-sub-header"><a href="/guide/request-handler.html#流程控制函数" class="sidebar-link">流程控制函数</a></li><li class="sidebar-sub-header"><a href="/guide/request-handler.html#设置请求路径" class="sidebar-link">设置请求路径</a></li><li class="sidebar-sub-header"><a href="/guide/request-handler.html#初始化和析构" class="sidebar-link">初始化和析构</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/request-handler.html#handler初始化" class="sidebar-link">Handler初始化</a></li><li class="sidebar-sub-header"><a href="/guide/request-handler.html#handler析构" class="sidebar-link">Handler析构</a></li></ul></li><li class="sidebar-sub-header"><a href="/guide/request-handler.html#中间件系统-2" class="sidebar-link">中间件系统</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/request-handler.html#中间件拦截" class="sidebar-link">中间件拦截</a></li></ul></li><li class="sidebar-sub-header"><a href="/guide/request-handler.html#请求预处理" class="sidebar-link">请求预处理</a></li><li class="sidebar-sub-header"><a href="/guide/request-handler.html#请求后处理" class="sidebar-link">请求后处理</a></li><li class="sidebar-sub-header"><a href="/guide/request-handler.html#统一完成处理" class="sidebar-link">统一完成处理</a></li><li class="sidebar-sub-header"><a href="/guide/request-handler.html#统一错误处理" class="sidebar-link">统一错误处理</a></li></ul></li><li><a href="/guide/log-collectting.html" class="sidebar-link">日志收集</a></li><li><a href="/guide/logger-introduce.html" class="sidebar-link">日志输出器</a></li><li><a href="/guide/logger-group-introduce.html" class="sidebar-link">日志输出组</a></li><li><a href="/guide/cluster-manager.html" class="sidebar-link">多进程架构</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>进阶</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/handler-manager.html" class="sidebar-link">Handler管理</a></li><li><a href="/guide/dynamic-middleware.html" class="sidebar-link">动态中间件</a></li><li><a href="/guide/static-resource.html" class="sidebar-link">静态资源</a></li><li><a href="/guide/logger-customizing.html" class="sidebar-link">自定义输出器</a></li><li><a href="/guide/logger-group-customizing.html" class="sidebar-link">自定义输出组</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="请求处理"><a href="#请求处理" class="header-anchor">#</a> 请求处理</h1> <h2 id="介绍"><a href="#介绍" class="header-anchor">#</a> 介绍</h2> <p><strong>Handler用于根据客户端请求路径进行针对性处理。</strong></p> <p>客户端请求进入<strong>ServiceCore</strong>后，将先后经过<a href="/guide/web-service.html#全局拦截器">全局拦截器</a>和<a href="/guide/web-service.html#全局中间件">全局中间件管道</a>。当<strong>全局中间件管道</strong>中的最后一个中间件执行完成后，<strong>ServiceCore</strong>将自动创建与请求路径匹配的<strong>Handler实例</strong>并引导请求进入其中进行后续处理。</p> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p><strong>Handler</strong>拥有独立于<strong>ServiceCore</strong>的<a href="#%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%B3%BB%E7%BB%9F-2">中间件系统</a>。因此，我们在<strong>Handler</strong>维度指定的中间件只作用于符合请求路径规则的客户端请求。</p> <p>另外，<strong>Handler的中间件系统兼容Express生态且支持动态中间件</strong>，我们可以根据客户端请求的实际上下文（比如：请求参数）：</p> <ul><li><strong>动态指定中间件列表</strong></li> <li><strong>控制中间件执行规则</strong>（比如：跳过执行）</li></ul></div> <p>在<a href="/guide/web-service.html#设置请求路径">Web服务-设置请求路径</a>一章中我们已经了解到，<strong>自定义Handler</strong>需要实现一个继承自<code>Core.Handler</code>的类。本质上<code>Core.Handler</code>是一个包含了核心处理流程的<strong>抽象类</strong>，我们通过实现<strong>抽象类</strong>内的HOOK方法以定制请求处理流程的各个环节。</p> <p><strong>下面，我们将分类介绍<code>Core.Handler</code>中推荐被重写的方法：</strong></p> <h3 id="请求路径"><a href="#请求路径" class="header-anchor">#</a> 请求路径</h3> <ul><li><p><strong><code>static getRoutePath()</code></strong></p> <ul><li><p><strong>使用场景</strong>：设置<strong>Handler</strong>的请求路径规则。<strong>ServiceCore</strong>处理客户端请求时，将根据请求路径指定完成实际处理动作的<strong>Handler实例</strong>。</p></li> <li><p><strong>调用时机</strong>：<strong>ServiceCore</strong>执行实例方法<code>bind()</code>时调用此方法获取<strong>Handler</strong>的请求路径规则。</p></li> <li><p><strong>注意事项</strong>：重写时无需执行<code>super</code>操作，使用<code>return</code>返回请求路径规则。</p> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p><strong>ServiceCore</strong>将自动校正<strong>Handler</strong>的请求路径规则：<strong>当请求路径规则不以<code>'/'</code>开头时，附加<code>'/'</code>作为前缀</strong>。</p> <p>因此，我们配置请求路径规则时应尽量以<code>'/'</code>开头。</p></div></li> <li><p><strong>默认行为</strong>：设置请求路径规则为<code>'/'</code>。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">static</span> <span class="token function">getRoutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token string">'/'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li></ul></li></ul> <h3 id="生命周期"><a href="#生命周期" class="header-anchor">#</a> 生命周期</h3> <ul><li><p><strong><code>initHandler(req, res, next)</code></strong></p> <ul><li><p><strong>使用场景</strong>：指定<a href="#handler%E5%88%9D%E5%A7%8B%E5%8C%96">Handler初始化</a>逻辑。</p> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>此方法中通常执行的是<strong>非业务相关的通用逻辑</strong>（比如：创建<strong>日志输出器</strong>），对于<strong>业务相关的初始化逻辑</strong>推荐放入<a href="#%E8%AF%B7%E6%B1%82%E9%A2%84%E5%A4%84%E7%90%86">请求预处理</a>或<a href="#%E8%AF%B7%E6%B1%82%E5%90%8E%E5%A4%84%E7%90%86">请求后处理</a>阶段。</p></div></li> <li><p><strong>调用时机</strong>：<strong>ServiceCore</strong>处理每个客户端请求时，都将创建与请求路径匹配的<strong>Handler实例</strong>并调用此方法触发<a href="#handler%E5%88%9D%E5%A7%8B%E5%8C%96">Handler初始化</a>。</p></li> <li><p><strong>注意事项</strong>：重写时无需执行<code>super</code>操作，当执行过程中产生异常时将触发<a href="#%E7%BB%9F%E4%B8%80%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">统一错误处理</a>。</p> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>我们在实现<a href="#handler%E5%88%9D%E5%A7%8B%E5%8C%96">Handler初始化</a>逻辑时，通常不直接操作<strong>客户端返回实例<code>res</code></strong>，而是通过<a href="#%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6%E5%87%BD%E6%95%B0">流程控制函数</a>控制请求处理链路。</p> <p>另外，为了更精确的捕获执行过程中异常，我们应<strong>根据阶段内实际逻辑的同步或异步指定此方法为<code>Function</code>或<code>AsyncFunction</code>。</strong></p></div></li> <li><p><strong>默认行为</strong>：直接调用<a href="#%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6%E5%87%BD%E6%95%B0">流程控制函数</a>进入下一处理阶段。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token function">initHandler</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li></ul></li> <li><p><strong><code>destroyHandler(req, res)</code></strong></p> <ul><li><p><strong>使用场景</strong>：指定<a href="#handler%E6%9E%90%E6%9E%84">Handler析构</a>逻辑。</p></li> <li><p><strong>调用时机</strong>：进入<strong>Handler</strong>处理的客户端请求返回时将调用此方法触发<a href="#handler%E6%9E%90%E6%9E%84">Handler析构</a>。</p> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p><strong>如果客户端请求在ServiceCore的<a href="/guide/web-service.html#全局拦截器">全局拦截器</a>和<a href="/guide/web-service.html#全局中间件">全局中间件管道</a>阶段返回则不会触发<a href="#handler%E6%9E%90%E6%9E%84">Handler析构</a>。</strong></p></div></li> <li><p><strong>注意事项</strong>：重写时无需执行<code>super</code>操作，当执行过程中产生异常时将触发<a href="#%E7%BB%9F%E4%B8%80%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">统一错误处理</a>。</p> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>进入<a href="#handler%E6%9E%90%E6%9E%84">Handler析构</a>阶段时，客户端请求已返回处理结果。因此，我们应仅对<strong>客户端请求实例</strong><code>req</code>和<strong>客户端返回实例</strong><code>res</code>发起读取动作。</p> <p>另外，为了更精确的捕获执行过程中异常，我们应<strong>根据阶段内实际逻辑的同步或异步指定此方法为<code>Function</code>或<code>AsyncFunction</code>。</strong></p></div></li></ul></li></ul> <h3 id="中间件系统"><a href="#中间件系统" class="header-anchor">#</a> 中间件系统</h3> <ul><li><p><strong><code>getMiddlewares(req, res)</code></strong></p> <ul><li><p><strong>使用场景</strong>：根据客户端请求的实际上下文（比如：请求参数）动态指定<a href="#%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%B3%BB%E7%BB%9F-2">Handler中间件</a>列表。</p></li> <li><p><strong>调用时机</strong>：在<a href="#handler%E5%88%9D%E5%A7%8B%E5%8C%96">Handler初始化</a>完成后将进入<strong>中间件阶段</strong>，在开始分发<strong>Handler中间件</strong>前将调用此方法获取<strong>中间件列表</strong>。</p></li> <li><p><strong>注意事项</strong>：重写时无需执行<code>super</code>操作，使用<code>return</code>返回<strong>中间件列表</strong>即可；当执行过程中产生异常时将触发<a href="#%E7%BB%9F%E4%B8%80%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">统一错误处理</a>。</p> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>我们在指定<strong>Handler</strong>的<strong>中间件列表</strong>时，通常不直接操作<strong>客户端返回实例<code>res</code></strong>。</p> <p>另外，为了更精确的捕获执行过程中异常，我们应<strong>根据阶段内实际逻辑的同步或异步指定此方法为<code>Function</code>或<code>AsyncFunction</code>。</strong></p></div></li> <li><p><strong>默认行为</strong>：返回<code>[]</code>。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token function">getMiddlewares</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li></ul></li> <li><p><strong><code>onInterceptMiddleware(middleware, req, res, next)</code></strong></p> <ul><li><p><strong>使用场景</strong>：<strong>动态中间件</strong>的核心HOOK方法，提供了<strong>在分发中间件时控制其执行行为</strong>的能力。</p></li> <li><p><strong>调用时机</strong>：<strong>中间件阶段</strong>分发每个中间件时，都将调用此方法完成中间件的实际执行行为。</p></li> <li><p><strong>注意事项</strong>：重写时无需执行<code>super</code>操作，当执行过程中产生异常时将触发<a href="#%E7%BB%9F%E4%B8%80%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">统一错误处理</a>。</p> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>我们在实现<strong>动态中间件</strong>时，通常不直接操作<strong>客户端返回实例<code>res</code></strong>，而是通过<a href="#%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6%E5%87%BD%E6%95%B0">流程控制函数</a>控制中间件的执行链路。</p> <p>在<strong>中间件拦截</strong>阶段，我们可以根据<strong>当前分发中间件</strong><code>middleware.type</code>的类型，决定是否调用<strong>中间件的执行函数</strong><code>middleware.exec</code>以实现对中间件执行行为的动态控制。</p></div></li> <li><p><strong>默认行为</strong>：执行中间件并将其结果作为执行<a href="#%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6%E5%87%BD%E6%95%B0">流程控制函数</a>的参数。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token function">onInterceptMiddleware</span><span class="token punctuation">(</span><span class="token parameter">middleware<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> exec <span class="token punctuation">}</span> <span class="token operator">=</span> middleware<span class="token punctuation">;</span>
  <span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">next</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li></ul></li></ul> <h3 id="请求处理-2"><a href="#请求处理-2" class="header-anchor">#</a> 请求处理</h3> <ul><li><p><strong><code>preHandler(req, res, next)</code></strong></p> <ul><li><p><strong>使用场景</strong>：根据中间件执行结果初始化处理客户端请求所需的基础环境，比如：参数聚合、创建基础资源等。</p></li> <li><p><strong>调用时机</strong>：在<strong>中间件阶段</strong>完成后（即：最后一个中间件的拦截阶段结束时），将调用此方法触发<a href="#%E8%AF%B7%E6%B1%82%E9%A2%84%E5%A4%84%E7%90%86">请求预处理</a>。</p></li> <li><p><strong>注意事项</strong>：重写时无需执行<code>super</code>操作，当执行过程中产生异常时将触发<a href="#%E7%BB%9F%E4%B8%80%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">统一错误处理</a>。</p> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>我们在指定<a href="#%E8%AF%B7%E6%B1%82%E9%A2%84%E5%A4%84%E7%90%86">请求预处理</a>逻辑时，通常不直接操作<strong>客户端返回实例<code>res</code></strong>，而是通过<a href="#%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6%E5%87%BD%E6%95%B0">流程控制函数</a>控制请求处理链路。</p> <p>另外，为了更精确的捕获执行过程中异常，我们应<strong>根据阶段内实际逻辑的同步或异步指定此方法为<code>Function</code>或<code>AsyncFunction</code>。</strong></p></div></li> <li><p><strong>默认行为</strong>：直接调用<a href="#%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6%E5%87%BD%E6%95%B0">流程控制函数</a>进入下一处理阶段。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token function">preHandler</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li></ul></li> <li><p><strong><code>[METHOD]Handler(req, res, next)</code></strong></p> <ul><li><p><strong>使用场景</strong>：根据客户端请求方式触发对应的业务处理逻辑。</p></li> <li><p><strong>调用时机</strong>：当<a href="#%E8%AF%B7%E6%B1%82%E9%A2%84%E5%A4%84%E7%90%86">请求预处理</a>阶段结束时，将调用与客户端请求方式匹配的实例方法以进入<a href="#%E8%AF%B7%E6%B1%82%E5%90%8E%E5%A4%84%E7%90%86">请求后处理</a>。</p></li> <li><p><strong>注意事项</strong>：重写时无需执行<code>super</code>操作，当执行过程中产生异常时将触发<a href="#%E7%BB%9F%E4%B8%80%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">统一错误处理</a>。</p> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p><strong><code>[METHOD]Handler</code>不是在指定<a href="#%E8%AF%B7%E6%B1%82%E5%90%8E%E5%A4%84%E7%90%86">请求后处理</a>逻辑时实际重写的方法名</strong>，只是<strong>Handler Method</strong>的代称，比如：处理客户端POST请求，我们应该重写<strong>Handler</strong>中的<strong>实例方法<code>postHandler()</code></strong>。</p> <p>我们在指定<a href="#%E8%AF%B7%E6%B1%82%E5%90%8E%E5%A4%84%E7%90%86">请求后处理</a>逻辑时，通常不直接操作<strong>客户端返回实例<code>res</code></strong>，而是通过<a href="#%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6%E5%87%BD%E6%95%B0">流程控制函数</a>控制请求处理链路。</p> <p>如果在<strong>Handler</strong>中没有实现与客户端请求方式匹配的<strong>实例方法</strong>，此时将调用<code>defaultHandler()</code>执行默认后处理逻辑。</p> <p>另外，为了更精确的捕获执行过程中异常，我们应<strong>根据阶段内实际逻辑的同步或异步指定此方法为<code>Function</code>或<code>AsyncFunction</code>。</strong></p></div></li></ul></li> <li><p><strong><code>defaultHandler(req, res, next)</code></strong></p> <ul><li><p><strong>使用场景</strong>：对请求方式不符合预期的客户端请求进行统一处理。</p></li> <li><p><strong>调用时机</strong>：当<a href="#%E8%AF%B7%E6%B1%82%E9%A2%84%E5%A4%84%E7%90%86">请求预处理</a>结束时，如果<strong>Handler</strong>中没有实现与客户端请求方式匹配的实例方法时，将调用此方法触发默认的<a href="#%E8%AF%B7%E6%B1%82%E5%90%8E%E5%A4%84%E7%90%86">请求后处理</a>。</p></li> <li><p><strong>注意事项</strong>：重写时无需执行<code>super</code>操作，当执行过程中产生异常时将触发<a href="#%E7%BB%9F%E4%B8%80%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">统一错误处理</a>。</p> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>我们在指定默认的<a href="#%E8%AF%B7%E6%B1%82%E5%90%8E%E5%A4%84%E7%90%86">请求后处理</a>逻辑时，通常不直接操作<strong>客户端返回实例<code>res</code></strong>，而是通过<a href="#%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6%E5%87%BD%E6%95%B0">流程控制函数</a>控制请求处理链路。</p> <p>另外，为了更精确的捕获执行过程中异常，我们应<strong>根据阶段内实际逻辑的同步或异步指定此方法为<code>Function</code>或<code>AsyncFunction</code>。</strong></p></div></li> <li><p><strong>默认行为</strong>：直接调用<a href="#%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6%E5%87%BD%E6%95%B0">流程控制函数</a>触发<a href="#%E7%BB%9F%E4%B8%80%E5%AE%8C%E6%88%90%E5%A4%84%E7%90%86">统一完成处理</a>向客户端返回404状态码。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token function">defaultHandler</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li></ul></li></ul> <h3 id="统一处理"><a href="#统一处理" class="header-anchor">#</a> 统一处理</h3> <ul><li><p><strong><code>onFinish(data, req, res)</code></strong></p> <ul><li><p><strong>使用场景</strong>：对客户端请求处理完成后的逻辑进行统一处理。</p></li> <li><p><strong>调用时机</strong>：在任意请求处理阶段使用<a href="#%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6%E5%87%BD%E6%95%B0">流程控制函数</a>执行<code>next(data)</code>时将调用此方法触发<a href="#%E7%BB%9F%E4%B8%80%E5%AE%8C%E6%88%90%E5%A4%84%E7%90%86">统一完成处理</a>。</p></li> <li><p><strong>注意事项</strong>：重写时无需执行<code>super</code>操作，当执行过程中产生异常时将触发<a href="#%E7%BB%9F%E4%B8%80%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">统一错误处理</a>。</p> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>我们在指定<a href="#%E7%BB%9F%E4%B8%80%E5%AE%8C%E6%88%90%E5%A4%84%E7%90%86">统一完成处理</a>逻辑时，通常应直接操作<strong>客户端返回实例<code>res</code></strong>，向客户端返回处理结果。</p> <p>另外，为了更精确的捕获执行过程中异常，我们应<strong>根据阶段内实际逻辑的同步或异步指定此方法为<code>Function</code>或<code>AsyncFunction</code>。</strong></p></div></li> <li><p><strong>默认行为</strong>：操作<strong>客户端返回实例<code>res</code></strong>，向客户端返回处理结果。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token function">onFinish</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 当请求已返回时不再执行实际逻辑</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>isEnded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 当data为null或undefined时 - 返回204</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isNullOrUndefined</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">204</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 当data为Number类型时 - data作为状态码</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getType</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token constant">VALUE_TYPE_NUMBER</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 其他情况 - data作为应答内容</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div></li></ul></li> <li><p><strong><code>onError(error, req, res)</code></strong></p> <ul><li><p><strong>使用场景</strong>：对客户端请求处理过程中产生的异常进行统一处理。</p></li> <li><p><strong>调用时机</strong>：在任意请求处理阶段的跟函数中产生了未被捕获的异常，或使用<a href="#%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6%E5%87%BD%E6%95%B0">流程控制函数</a>执行<code>next(error)</code>时，将调用此方法触发<a href="#%E7%BB%9F%E4%B8%80%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">统一错误处理</a>。</p></li> <li><p><strong>注意事项</strong>：重写时无需执行<code>super</code>操作，当执行过程中产生异常时将触发<strong>ServiceCore</strong>中的<a href="/guide/web-service.html#错误拦截器">错误拦截器</a>。</p> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>我们在指定<a href="#%E7%BB%9F%E4%B8%80%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">统一错误处理</a>逻辑时，通常应直接操作<strong>客户端返回实例<code>res</code></strong>，向客户端返回处理结果。</p> <p>另外，为了更精确的捕获执行过程中异常，我们应<strong>根据阶段内实际逻辑的同步或异步指定此方法为<code>Function</code>或<code>AsyncFunction</code>。</strong></p></div></li> <li><p><strong>默认行为</strong>：操作<strong>客户端返回实例<code>res</code></strong>，向客户端返回500状态码。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token function">onError</span><span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>isEnded <span class="token operator">&amp;&amp;</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li></ul></li></ul> <h2 id="处理流程"><a href="#处理流程" class="header-anchor">#</a> 处理流程</h2> <p><img src="/images/Handler%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B.jpg" alt="Handler处理流程"></p> <h2 id="流程控制函数"><a href="#流程控制函数" class="header-anchor">#</a> 流程控制函数</h2> <p><strong>ServiceCore</strong>自动为<strong>每个客户端请求</strong>创建与请求路径对应的<strong>Handler实例</strong>，并调用其私有实例方法<code>_onStart()</code>以启动处理流程。</p> <div class="custom-block danger"><p class="custom-block-title">注意</p> <p>Handler的实例方法<code>_onStart()</code>中实现了处理流程控制逻辑。<strong>因此，我们在自定义Handler时，一定不要使用<code>_onStart</code>作为实例方法名。</strong></p></div> <p>通常，我们仅在指定<a href="#%E7%BB%9F%E4%B8%80%E5%AE%8C%E6%88%90%E5%A4%84%E7%90%86">统一完成处理</a>和<a href="#%E7%BB%9F%E4%B8%80%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">统一错误处理</a>阶段直接操作<strong>客户端返回实例<code>res</code></strong>，其余阶段中使用<code>next</code>进行流程控制：</p> <ul><li><p><strong>执行<code>next(data)</code>时</strong>：触发<a href="#%E7%BB%9F%E4%B8%80%E5%AE%8C%E6%88%90%E5%A4%84%E7%90%86">统一完成处理</a>，<code>data</code>将作为实例方法<code>onFinish()</code>参数列表的第一个入参。</p> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p><strong>默认的<a href="#%E7%BB%9F%E4%B8%80%E5%AE%8C%E6%88%90%E5%A4%84%E7%90%86">统一完成处理</a>逻辑使流程控制函数支持多种调用方式向客户端返回请求处理结果：</strong></p> <ul><li><p><strong><code>next(message)</code></strong>：</p> <p>当<strong>流程控制函数</strong>指定的<code>data</code><strong>不为<code>Number</code>类型、<code>null</code>和<code>undefined</code>时</strong>，认为期望向客户端返回处理结果报文。</p> <p>此时，将<strong>向客户端返回200状态码，并将<code>data</code>作为返回报文。</strong></p></li> <li><p><strong><code>next(httpCode)</code></strong>：</p> <p>当<strong>流程控制函数</strong>指定的<code>data</code><strong>为<code>Number</code>类型时</strong>，认为期望向客户端返回状态码。</p> <p>此时，将<strong>向客户端返回<code>data</code>中指定的状态码和空报文。</strong></p></li> <li><p><strong><code>next()</code>、<code>next(null)</code>、<code>next(undefined)</code></strong>：</p> <blockquote><p><strong>仅在<a href="#%E8%AF%B7%E6%B1%82%E5%90%8E%E5%A4%84%E7%90%86">请求后处理</a>阶段执行<code>next()</code>时命中此逻辑，其余处理阶段中执行<code>next()</code>将分发至下一处理阶段。</strong></p></blockquote> <p>当<strong>流程控制函数</strong>指定的<code>data</code><strong>为<code>null</code>或<code>undefined</code>时</strong>，认为期望向客户端返回空报文。</p> <p>此时，将<strong>向客户端返回204状态码和空报文。</strong></p></li></ul> <p><strong>我们可以通过指定<a href="#%E7%BB%9F%E4%B8%80%E5%AE%8C%E6%88%90%E5%A4%84%E7%90%86">统一完成处理</a>阶段的逻辑以定制流程控制函数向客户端返回请求处理结果的方式。</strong></p></div></li> <li><p><strong>执行<code>next(error)</code>时</strong>：触发<a href="#%E7%BB%9F%E4%B8%80%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">统一错误处理</a>，<code>error</code>将作为实例方法<code>onError()</code>参数列表的第一个入参。</p></li> <li><p><strong>执行<code>next()</code>、<code>next(null)</code>、<code>next(undefined)</code>时</strong>：进入下一处理阶段。</p></li></ul> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p><strong>Handler的流程控制函数与Express的中间件分发函数拥有一致的使用体验。因此，我们可以在Handler的中间件系统直接使用Express的中间件生态。</strong></p> <p>不得不提的是，在<strong>自定义Handler</strong>时，我们<strong>应按照Handler处理阶段对业务逻辑进行拆分以实现各个HOOK方法，并在期望阶段处理结束时使用<code>next()</code>分发处理流程。</strong></p> <p>虽然在实现上，<strong>Handler</strong>使用<strong>洋葱圈模型</strong>串联了每个请求处理阶段，理论上可以通过<code>await next()</code>进行二次穿透。</p></div> <h2 id="设置请求路径"><a href="#设置请求路径" class="header-anchor">#</a> 设置请求路径</h2> <p>在<a href="/guide/web-service.html#设置请求路径">Web服务-设置请求路径</a>一章中，我们已经了解了如何通过重写<strong>Handler</strong>的静态方法<code>getRoutePath()</code>以指定<strong>Handler</strong>的请求路径规则。</p> <p>接下来，我们将重点讨论指定<strong>请求路径规则</strong>时的注意事项：</p> <ul><li><p><strong>请求路径规则必须为非空字符串。</strong></p> <p><strong>ServiceCore</strong>在执行<code>bind()</code>时，将对<strong>Handler</strong>中指定的<strong>请求路径规则</strong>进行校验，如果为非字符串型值或空字符串将跳过对此<strong>Handler</strong>的挂载。</p></li> <li><p><strong>请求路径规则</strong>应尽量使用<code>'/'</code>开头。</p> <p><strong>ServiceCore</strong>在执行<code>bind()</code>时，还将对<strong>Handler</strong>中指定的<strong>请求路径规则</strong>进行校正，如果不以<code>'/'</code>开头时，将自动附加<code>'/'</code>作为前缀。</p></li> <li><p><strong>使用前缀型请求路径规则场景下，在业务层执行<code>bind()</code>时，应将指定了更长请求路径规则的Handler放置于绑定列表中较前的位置。</strong></p> <p><strong>ServiceCore</strong>匹配与客户端请求对应的<strong>Handler</strong>时，将按照执行<code>bind()</code>时的指定的<strong>Handler</strong>顺序依次进行。</p> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p>比如，业务层在执行<code>bind()</code>时依次绑定了两个<strong>Handler</strong>，其<strong>请求路径规则</strong>分别为<code>'/api'</code>和<code>'/api/Test.do'</code>。</p> <p>此时当客户端请求路径为<code>/api/Test.do</code>时，<strong>ServiceCore</strong>将优先匹配到<strong>请求路径规则</strong>为<code>/api</code>的<strong>Handler</strong>用于此次请求处理。</p> <p>因此，我们在使用前缀型<strong>请求路径规则</strong>场景下，应在执行<code>bind()</code>时关注绑定列表中的<strong>Handler</strong>顺序。</p></div></li></ul> <h2 id="初始化和析构"><a href="#初始化和析构" class="header-anchor">#</a> 初始化和析构</h2> <p><strong>Handler</strong>的初始化和析构标志着<strong>Handler</strong>生命周期的开始和结束：</p> <ul><li>当<strong>ServiceCore</strong>分发客户端请求进入与请求路径匹配的<strong>Handler</strong>时，首先将触发<a href="#handler%E5%88%9D%E5%A7%8B%E5%8C%96">Handler初始化</a>。</li> <li>在<a href="#handler%E5%88%9D%E5%A7%8B%E5%8C%96">Handler初始化</a>触发后（<strong>非初始化执行完成后</strong>），客户端请求返回时将触发<a href="#handler%E6%9E%90%E6%9E%84">Handler析构</a>。</li></ul> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>通常，我们仅在<a href="#%E7%BB%9F%E4%B8%80%E5%AE%8C%E6%88%90%E5%A4%84%E7%90%86">统一完成处理</a>和<a href="#%E7%BB%9F%E4%B8%80%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">统一错误处理</a>中操作<strong>客户端返回实例<code>res</code></strong>，向客户端返回请求处理结果以触发<a href="#handler%E6%9E%90%E6%9E%84">Handler析构</a>。</p> <p>当然也有例外，比如在<strong>Handler</strong>中使用<strong>静态资源中间件<code>express.static</code></strong>，当客户端请求命中静态资源时将直接返回该资源，此时也将触发<a href="#handler%E6%9E%90%E6%9E%84">Handler析构</a>。</p> <p>我们应在<a href="#handler%E5%88%9D%E5%A7%8B%E5%8C%96">Handler初始化</a>与<a href="#handler%E6%9E%90%E6%9E%84">Handler析构</a>阶段执行<strong>相反的资源操作</strong>，以使内存得到有效释放。</p></div> <h3 id="handler初始化"><a href="#handler初始化" class="header-anchor">#</a> Handler初始化</h3> <p><strong>我们通过重写Handler的实例方法<code>initHandler()</code>以指定Handler初始化阶段执行的逻辑。</strong></p> <p>出于复用性考虑，推荐在<strong>Handler初始化</strong>阶段执行一些<strong>与业务无关的通用初始化逻辑</strong>，比如：<strong>创建日志输出器</strong>、<strong>读取全局配置</strong>等；<strong>与业务相关的初始化逻辑</strong>推荐放入<a href="#%E8%AF%B7%E6%B1%82%E9%A2%84%E5%A4%84%E7%90%86">请求预处理</a>阶段中。</p> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>通常，我们将<strong>Handler初始化</strong>阶段中创建的资源提升为<strong>实例属性</strong>，以在各个请求处理阶段中共享：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token function">initHandler</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 创建基础输出器并提升为实例属性</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>logger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Core<span class="token punctuation">.</span>BaseLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 分发至下一处理阶段</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></div> <p><strong>Handler内置的异常捕获套件将自动作用在实例方法<code>initHandler</code>维度</strong>。即：当<code>initHandler</code>执行过程中产生了未被捕获的异常时将自动进入<a href="#%E7%BB%9F%E4%B8%80%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">统一错误处理</a>。</p> <p>因此，我们应<strong>根据Handler初始化阶段中实际逻辑的同步或异步，选择使用<code>Function</code>或<code>AsyncFunction</code>类型的<code>initHandler</code>。</strong></p> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p><strong>Handler内置的异常捕获机制仅在请求处理节点的根函数中产生未被捕获的异常时才产生效力。</strong></p> <p>因此，当<strong>Handler初始化</strong>逻辑中包含<strong>异步任务</strong>时，我们<strong>可以使用<code>async/await</code>和<code>Promise</code>处理异步任务，以保证异常可以正常抛出。</strong></p></div> <p>当然，不要忘记在<strong>Handler初始化</strong>阶段结束时使用<a href="#%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6%E5%87%BD%E6%95%B0">流程控制函数</a>分发处理流程至下一阶段。</p> <hr> <p><strong>接下来，我们将实现一个在处理请求时打印请求处理开始时间的Handler。</strong></p> <p>首先，创建一个用于<strong>模拟耗时同步和异步任务</strong>的<code>BaseHandler</code>作为基类：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">BaseHandler</span> <span class="token keyword">extends</span> <span class="token class-name">Core<span class="token punctuation">.</span>Handler</span> <span class="token punctuation">{</span>
  <span class="token comment">// 异步耗时任务</span>
  <span class="token function">asyncTask</span><span class="token punctuation">(</span><span class="token parameter">duration <span class="token operator">=</span> <span class="token number">0</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> duration<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 同步耗时任务</span>
  <span class="token function">syncTask</span><span class="token punctuation">(</span><span class="token parameter">duration <span class="token operator">=</span> <span class="token number">0</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> startDate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> startDate<span class="token punctuation">)</span> <span class="token operator">&gt;</span> duration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>接下来，基于<code>BaseHandler</code>实现在请求处理时打印开始时间的<strong>自定义Handler</strong>：</p> <p><strong>对于只包含同步行为的Handler初始化逻辑，我们使用<code>Function</code>类型的<code>initHandler</code>：</strong></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">Handler</span> <span class="token keyword">extends</span> <span class="token class-name">BaseHandler</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token function">getRoutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'/Test.do'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">initHandler</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 记录请求时间</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>startDate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 创建日志输出器并打印日志</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>logger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Core<span class="token punctuation">.</span>BaseLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">请求处理开始时间:[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>startDate<span class="token punctuation">.</span><span class="token function">toLocaleString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 执行1000ms的同步任务</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">syncTask</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>同样，<strong>当Handler初始化逻辑中包含异步行为时，我们使用<code>AsyncFunction</code>类型的<code>initHandler</code>，并通过<code>await</code>关键字执行异步任务</strong>：</p> <div class="language-javascript line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br></div><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">Handler</span> <span class="token keyword">extends</span> <span class="token class-name">BaseHandler</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token function">getRoutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'/Test.do'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">initHandler</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 记录请求时间</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>startDate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 创建日志输出器并打印日志</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>logger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Core<span class="token punctuation">.</span>BaseLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">请求处理开始时间:[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>startDate<span class="token punctuation">.</span><span class="token function">toLocaleString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 执行1000ms的异步任务</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">asyncTask</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>最后，我们将<strong>自定义Handler</strong>挂载至<strong>ServiceCore</strong>并启动服务：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> serviceCore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Core<span class="token punctuation">.</span>ServiceCore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">serviceCore</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token punctuation">[</span>Handler<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
serviceCore<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>最后的最后，我们打开控制台，使用<code>curl http://localhost:3000/Test.do -w 'res -&gt; %{http_code}\n'</code>检查实现效果：</strong></p> <ul><li><p>服务端控制台将于收到请求时打印<strong>请求开始处理时间</strong>的相关日志。</p></li> <li><p>客户端控制台将于请求发起后约<strong>1000ms</strong>收到<strong>ServiceCore</strong>返回的404状态码。</p></li></ul> <h3 id="handler析构"><a href="#handler析构" class="header-anchor">#</a> Handler析构</h3> <p><strong>我们通过重写Handler的实例方法<code>destroyHandler()</code>以指定Handler析构阶段执行的逻辑。</strong></p> <div class="custom-block danger"><p class="custom-block-title">注意</p> <p><strong>进入Handler析构阶段时，客户端请求已返回处理结果。</strong></p> <p>因此，我们在<strong>Handler析构</strong>阶段仅允许对<strong>客户端请求实例</strong><code>req</code>和<strong>客户端返回实例</strong><code>res</code>发起读取动作。</p> <p>通常，我们在<strong>Handler析构</strong>阶段释放对<a href="#handler%E5%88%9D%E5%A7%8B%E5%8C%96">Handler初始化</a>阶段创建资源的引用。</p></div> <p>当然，不要忘记在<strong>Handler初始化</strong>阶段结束时使用<a href="#%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6%E5%87%BD%E6%95%B0">流程控制函数</a>分发处理流程至下一阶段。</p> <p>同样，<strong>Handler内置的异常捕获套件也将自动作用在实例方法<code>destroyHandler</code>维度</strong>。即：当<code>destroyHandler</code>执行过程中产生了未被捕获的异常时将自动进入<a href="#%E7%BB%9F%E4%B8%80%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">统一错误处理</a>。</p> <p>因此，我们应<strong>根据Handler析构阶段中实际逻辑的同步或异步，选择使用<code>Function</code>或<code>AsyncFunction</code>类型的<code>destroyHandler</code>。</strong></p> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p><strong>Handler内置的异常捕获机制仅在请求处理节点的根函数中产生未被捕获的异常时才产生效力。</strong></p> <p>因此，当<strong>Handler析构</strong>逻辑中包含异步任务时，我们<strong>可以使用<code>async/await</code>和<code>Promise</code>处理异步任务，以保证异常可以正常抛出。</strong></p></div> <p><strong>Handler析构</strong>阶段标志着<strong>Handler生命周期</strong>的终结，其中无法使用<a href="#%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6%E5%87%BD%E6%95%B0">流程控制函数</a>。</p> <hr> <p><strong>接下来，我们将完善Handler初始化阶段中的🌰，使其在请求处理结束时执行任务并打印处理耗时。</strong></p> <p><strong>对于只包含同步行为的Handler析构逻辑，我们使用<code>Function</code>类型的<code>destroyHandler</code>：</strong></p> <div class="language-javascript line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br></div><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">Handler</span> <span class="token keyword">extends</span> <span class="token class-name">BaseHandler</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token function">getRoutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'/Test.do'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">initHandler</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 记录请求时间</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>startDate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 创建日志输出器并打印日志</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>logger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Core<span class="token punctuation">.</span>BaseLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">请求处理开始时间:[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>startDate<span class="token punctuation">.</span><span class="token function">toLocaleString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 执行1000ms的同步任务</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">syncTask</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">destroyHandler</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 执行1000ms的同步任务</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">syncTask</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 计算并打印日志</span>
    <span class="token keyword">const</span> duration <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>startDate<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">请求处理耗时[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>duration<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]ms</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 关闭日志输出器</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>同样，<strong>当Handler析构逻辑中包含异步行为时，我们使用<code>AsyncFunction</code>类型的<code>destroyHandler</code>，并通过<code>await</code>关键字执行异步任务</strong>：</p> <div class="language-javascript line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br></div><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">Handler</span> <span class="token keyword">extends</span> <span class="token class-name">BaseHandler</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token function">getRoutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'/Test.do'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">initHandler</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 记录请求时间</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>startDate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 创建日志输出器并打印日志</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>logger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Core<span class="token punctuation">.</span>BaseLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">请求处理开始时间:[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>startDate<span class="token punctuation">.</span><span class="token function">toLocaleString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 执行1000ms的异步任务</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">asyncTask</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">destroyHandler</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 执行1000ms的同步任务</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">asyncTask</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 计算并打印日志</span>
    <span class="token keyword">const</span> duration <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>startDate<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">请求处理耗时[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>duration<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]ms</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 关闭日志输出器</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p><strong>最后，我们打开控制台，使用<code>curl http://localhost:3000/Test.do -w 'res -&gt; %{http_code}\n'</code>检查实现效果：</strong></p> <ul><li><p>服务端控制台将于收到请求时打印<strong>请求开始处理时间</strong>的相关日志。</p></li> <li><p>服务端控制台将于收到请求后约<strong>2000ms</strong>打印<strong>请求处理时长</strong>的相关日志。</p></li> <li><p>客户端控制台将于请求发起后约<strong>1000ms</strong>收到<strong>ServiceCore</strong>返回的404状态码。</p></li></ul> <h2 id="中间件系统-2"><a href="#中间件系统-2" class="header-anchor">#</a> 中间件系统</h2> <p><strong>Handler使用的中间件系统兼容Express生态，且支持动态中间件</strong>。</p> <p><strong>我们通过重写Handler的实例方法<code>getMiddlewares</code>以指定其应用于客户端请求的中间件列表。</strong></p> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>在<a href="#handler%E5%88%9D%E5%A7%8B%E5%8C%96">Handler初始化</a>阶段完成后，<strong>Handler</strong>将构建并执行<strong>中间件列表</strong>。</p> <p>需要注意的是：<strong>Handler维度指定的中间件将仅作用于匹配Handler请求路径规则的客户端请求。</strong></p></div> <p>同样，<strong>Handler内置的异常捕获套件也将自动作用在实例方法<code>getMiddlewares</code>维度</strong>。即：当<code>getMiddlewares</code>执行过程中产生了未被捕获的异常时将自动进入<a href="#%E7%BB%9F%E4%B8%80%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">统一错误处理</a>。</p> <p>因此，我们应<strong>根据构建中间件列表时实际逻辑的同步或异步，选择使用<code>Function</code>或<code>AsyncFunction</code>类型的<code>getMiddlewares</code>。</strong></p> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p><strong>Handler内置的异常捕获机制仅在请求处理节点的根函数中产生未被捕获的异常时才产生效力。</strong></p> <p>因此，当<strong>构建中间件列表</strong>逻辑中包含异步任务时，我们<strong>可以使用<code>async/await</code>和<code>Promise</code>处理异步任务，以保证异常可以正常抛出。</strong></p></div> <p>构建<strong>中间件列表</strong>时无需使用<a href="#%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6%E5%87%BD%E6%95%B0">流程控制函数</a>控制处理流程，使用<code>return</code>关键字返回应用于客户端请求处理的<strong>中间件列表</strong>即可。</p> <hr> <p><strong>接下来，我们将实现一个在请求处理过程中动态指定中间件列表的Handler。</strong></p> <p>首先，创建一个用于<strong>模拟耗时同步、异步任务和创建中间件</strong>的<code>BaseHandler</code>作为基类：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">BaseHandler</span> <span class="token keyword">extends</span> <span class="token class-name">Core<span class="token punctuation">.</span>Handler</span> <span class="token punctuation">{</span>
  <span class="token comment">// 异步任务</span>
  <span class="token function">asyncTask</span><span class="token punctuation">(</span><span class="token parameter">duration <span class="token operator">=</span> <span class="token number">0</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> duration<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 同步任务</span>
  <span class="token function">syncTask</span><span class="token punctuation">(</span><span class="token parameter">duration <span class="token operator">=</span> <span class="token number">0</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> startDate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> startDate<span class="token punctuation">)</span> <span class="token operator">&gt;</span> duration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 创建中间件</span>
  <span class="token function">createMiddleware</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 将在res.header中自动记录应用于请求处理的中间件</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> middlewareFieldKey <span class="token operator">=</span> <span class="token string">'x-middlewares'</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> middlewareFieldValue <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>middlewareFieldKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> middlewareList <span class="token operator">=</span> middlewareFieldValue <span class="token operator">?</span> middlewareFieldValue<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      middlewareList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">middleware_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>middlewareFieldKey<span class="token punctuation">,</span> middlewareList<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>接下来，基于<code>BaseHandler</code>实现根据客户端请求入参动态指定中间件列表的<strong>自定义Handler</strong>：</p> <p><strong>对于只包含同步行为的构建中间件列表逻辑，我们使用<code>Function</code>类型的<code>getMiddlewares</code>：</strong></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">Handler</span> <span class="token keyword">extends</span> <span class="token class-name">BaseHandler</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token function">getRoutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'/Test.do'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token function">getMiddlewares</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 执行1000ms的同步任务</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">syncTask</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 构建中间件列表</span>
    <span class="token keyword">const</span> middlewares <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> count <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      middlewares<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createMiddleware</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> middlewares<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>同样，<strong>当构建中间件列表逻辑中包含异步行为时，我们使用<code>AsyncFunction</code>类型的<code>getMiddlewares</code>，并通过<code>await</code>关键字执行异步任务</strong>：</p> <div class="language-javascript line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br></div><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">Handler</span> <span class="token keyword">extends</span> <span class="token class-name">BaseHandler</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token function">getRoutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'/Test.do'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">async</span> <span class="token function">getMiddlewares</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 执行1000ms的异步任务</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">asyncTask</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 构建中间件列表</span>
    <span class="token keyword">const</span> middlewares <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> count <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      middlewares<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createMiddleware</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> middlewares<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>最后，我们将<strong>自定义Handler</strong>挂载至<strong>ServiceCore</strong>并启动服务：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> serviceCore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Core<span class="token punctuation">.</span>ServiceCore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">serviceCore</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token punctuation">[</span>Handler<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
serviceCore<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>最后的最后，我们打开控制台，使用<code>curl http://localhost:3000/Test.do\?count\=5 -D -</code>检查实现效果：</strong></p> <ul><li><p>客户端控制台将于请求发起后约<strong>1000ms</strong>打印请求处理结果。</p></li> <li><p>客户端收到的请求处理结果中<code>res.header['x-middlewares']</code>内<strong>记录了5个中间件的信息</strong>。</p></li></ul> <h3 id="中间件拦截"><a href="#中间件拦截" class="header-anchor">#</a> 中间件拦截</h3> <p><strong>Handler构建中间件列表完成后，将逐个分发其中的中间件。</strong></p> <p><strong>我们通过重写实例方法<code>onInterceptMiddleware</code>以拦截每个中间件的分发以动态控制其执行行为。</strong></p> <p>同样，<strong>Handler内置的异常捕获套件也将自动作用在实例方法<code>onInterceptMiddleware</code>维度</strong>。即：当<code>onInterceptMiddleware</code>执行过程中产生了未被捕获的异常时将自动进入<a href="#%E7%BB%9F%E4%B8%80%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">统一错误处理</a>。</p> <p>因此，我们应<strong>根据中间件拦截时实际逻辑的同步或异步，选择使用<code>Function</code>或<code>AsyncFunction</code>类型的<code>onInterceptMiddleware</code>。</strong></p> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p><strong>Handler内置的异常捕获机制仅在请求处理节点的根函数中产生未被捕获的异常时才产生效力。</strong></p> <p>因此，当<strong>中间件拦截</strong>逻辑中包含异步任务时，我们<strong>可以使用<code>async/await</code>和<code>Promise</code>处理异步任务，以保证异常可以正常抛出。</strong></p></div> <p><strong>Handler</strong>将自动包装<strong>当前分发的中间件</strong>和<strong>中间件执行函数</strong>作为<code>onInterceptMiddleware</code>参数列表的第一个参数<code>middleware</code>：</p> <ul><li><p><strong><code>middleware.type</code></strong>：中间件本体函数，用于进行中间件标识校验。</p></li> <li><p><strong><code>middleware.exec</code></strong>：中间件执行函数，用于实际执行中间件，其参数列表为<code>(callBack)</code>。</p> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p><strong><code>middleware.exec(callBack)</code>实际上是<code>middleware.type(req, res, callBack)</code>的语法糖，中间件执行过程中产生的异常将通过<code>callBack</code>回抛。</strong></p> <p><strong>我们可以通过<code>require('util').promisify</code>包装<code>middleware.exec</code>，并使用<code>await</code>关键字调用</strong>，以保证在<code>AsyncFuntion</code>类型的<code>onInterceptMiddleware</code>中的逻辑一致性。</p></div></li></ul> <p>当然，在对中间件进行拦截处理后，不要忘记使用<a href="#%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6%E5%87%BD%E6%95%B0">流程控制函数</a>分发处理流程至下一阶段。</p> <hr> <p><strong>接下来，我们将完善构建中间件列表时的🌰，以50%的概率随机执行中间件列表中的中间件。</strong></p> <p><strong>对于只包含同步行为的中间件拦截逻辑，我们使用<code>Function</code>类型的<code>onInterceptMiddleware</code>：</strong></p> <div class="language-javascript line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br></div><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">Handler</span> <span class="token keyword">extends</span> <span class="token class-name">BaseHandler</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token function">getRoutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'/Test.do'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token function">getMiddlewares</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 执行1000ms的同步任务</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">syncTask</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 构建中间件列表</span>
    <span class="token keyword">const</span> middlewares <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> count <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      middlewares<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createMiddleware</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> middlewares<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">onInterceptMiddleware</span><span class="token punctuation">(</span><span class="token parameter">middleware<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 每个中间件都执行500ms的同步任务</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">syncTask</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 计算概率并应用至执行链路</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> exec <span class="token punctuation">}</span> <span class="token operator">=</span> middleware<span class="token punctuation">;</span>
    <span class="token keyword">const</span> canExec <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
    canExec <span class="token operator">?</span> <span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">next</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>同样，<strong>当构中间件拦截逻辑中包含异步行为时，我们使用<code>AsyncFunction</code>类型的<code>onInterceptMiddleware</code>，并通过<code>await</code>关键字执行异步任务</strong>：</p> <div class="language-javascript line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br></div><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> promisify <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'util'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Handler</span> <span class="token keyword">extends</span> <span class="token class-name">BaseHandler</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token function">getRoutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'/Test.do'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">getMiddlewares</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 执行1000ms的异步任务</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">asyncTask</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 构建中间件列表</span>
    <span class="token keyword">const</span> middlewares <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> count <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      middlewares<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createMiddleware</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> middlewares<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">onInterceptMiddleware</span><span class="token punctuation">(</span><span class="token parameter">middleware<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 每个中间件都执行500ms的异步任务</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">asyncTask</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 计算概率并应用至执行链路</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> exec <span class="token punctuation">}</span> <span class="token operator">=</span> middleware<span class="token punctuation">;</span>
    <span class="token keyword">const</span> canExec <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
    canExec
      <span class="token operator">?</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">promisify</span><span class="token punctuation">(</span>exec<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p><strong>最后，我们打开控制台，使用<code>curl http://localhost:3000/Test.do\?count\=5 -D -</code>检查实现效果：</strong></p> <ul><li><p>客户端控制台将于请求发起后约<strong>3500ms</strong>打印请求处理结果。</p></li> <li><p>客户端收到的请求处理结果中<code>res.header['x-middlewares']</code>内<strong>随机记录了0-5个中间件的信息</strong>。</p></li></ul> <h2 id="请求预处理"><a href="#请求预处理" class="header-anchor">#</a> 请求预处理</h2> <p><strong>Handler</strong>维度的<strong>中间件列表</strong>内最后一个中间件的拦截逻辑执行完成后，将进入<strong>请求预处理</strong>阶段。</p> <p><strong>我们通过重写Handler的实例方法<code>preHandler()</code>以指定请求预处理阶段执行的逻辑。</strong></p> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p><strong>通常，我们在请求预处理阶段执行实际业务处理前的准备动作。</strong></p> <p>比如，在实现支持客户端使用多种请求方式的<strong>自定义Handler</strong>时，可以在<strong>请求预处理</strong>阶段对不同请求方式带入的参数进行归并统一。</p> <p>或是<strong>提前创建请求处理所需的基础资源</strong>。</p> <blockquote><p><strong>我们通常在<a href="#%E8%AF%B7%E6%B1%82%E5%90%8E%E5%A4%84%E7%90%86">请求后处理</a>阶段对请求参数进行有效性校验并驳回参数无效的客户端请求。因此，出于性能考虑，我们应在请求预处理阶段创建与客户端请求类型无关的基础资源。</strong></p></blockquote></div> <p>同样，<strong>Handler内置的异常捕获套件也将自动作用在实例方法<code>preHandler</code>维度</strong>。即：当<code>preHandler</code>执行过程中产生了未被捕获的异常时将自动进入<a href="#%E7%BB%9F%E4%B8%80%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">统一错误处理</a>。</p> <p>因此，我们应<strong>根据请求预处理中实际逻辑的同步或异步，选择使用<code>Function</code>或<code>AsyncFunction</code>类型的<code>preHandler</code>。</strong></p> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p><strong>Handler内置的异常捕获机制仅在请求处理节点的根函数中产生未被捕获的异常时才产生效力。</strong></p> <p>因此，当<strong>请求预处理</strong>逻辑中包含异步任务时，我们<strong>可以使用<code>async/await</code>和<code>Promise</code>处理异步任务，以保证异常可以正常抛出。</strong></p></div> <p>当然，不要忘记在<strong>请求预处理</strong>阶段结束时使用<a href="#%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6%E5%87%BD%E6%95%B0">流程控制函数</a>分发处理流程至下一阶段。</p> <hr> <p><strong>接下来，我们将实现一个在预处理阶段归并请求参数并向客户端返回的Handler。</strong></p> <p>首先，创建一个用于<strong>模拟耗时同步和异步任务</strong>的<code>BaseHandler</code>作为基类：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">BaseHandler</span> <span class="token keyword">extends</span> <span class="token class-name">Core<span class="token punctuation">.</span>Handler</span> <span class="token punctuation">{</span>
  <span class="token comment">// 异步耗时任务</span>
  <span class="token function">asyncTask</span><span class="token punctuation">(</span><span class="token parameter">duration <span class="token operator">=</span> <span class="token number">0</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> duration<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 同步耗时任务</span>
  <span class="token function">syncTask</span><span class="token punctuation">(</span><span class="token parameter">duration <span class="token operator">=</span> <span class="token number">0</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> startDate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> startDate<span class="token punctuation">)</span> <span class="token operator">&gt;</span> duration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>接下来，基于<code>BaseHandler</code>实现自动归并<strong>GET方式</strong>和<strong>POST方式</strong>中客户端附加至<code>query</code>和<code>body</code>中参数的<strong>自定义Handler</strong>：</p> <p><strong>对于只包含同步行为的请求预处理逻辑，我们使用<code>Function</code>类型的<code>preHandler</code>：</strong></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> bodyParser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'body-parser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> jsonParserMiddleware <span class="token operator">=</span> bodyParser<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> limit<span class="token operator">:</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> qsParserMiddleware <span class="token operator">=</span> bodyParser<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">{</span> limit<span class="token operator">:</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">,</span> extended<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Handler</span> <span class="token keyword">extends</span> <span class="token class-name">BaseHandler</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token function">getRoutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'/Test.do'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">getMiddlewares</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 挂载解析HTTP BODY的中间件</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>jsonParserMiddleware<span class="token punctuation">,</span> qsParserMiddleware<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">preHandler</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 执行1000ms的同步任务</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">syncTask</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 合并query和body</span>
    <span class="token keyword">const</span> body <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
    <span class="token keyword">const</span> query <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">;</span>
    req<span class="token punctuation">.</span>requestParams <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> body<span class="token punctuation">,</span> query<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 向客户端返回</span>
    <span class="token function">next</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>requestParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>同样，<strong>当请求预处理逻辑中包含异步行为时，我们使用<code>AsyncFunction</code>类型的<code>preHandler</code>，并通过<code>await</code>关键字执行异步任务</strong>：</p> <div class="language-javascript line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br></div><pre class="language-javascript"><code><span class="token keyword">const</span> bodyParser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'body-parser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> jsonParserMiddleware <span class="token operator">=</span> bodyParser<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> limit<span class="token operator">:</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> qsParserMiddleware <span class="token operator">=</span> bodyParser<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">{</span> limit<span class="token operator">:</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">,</span> extended<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Handler</span> <span class="token keyword">extends</span> <span class="token class-name">BaseHandler</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token function">getRoutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'/Test.do'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">getMiddlewares</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 挂载解析HTTP BODY的中间件</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>jsonParserMiddleware<span class="token punctuation">,</span> qsParserMiddleware<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">preHandler</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 执行1000ms的异步任务</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">asyncTask</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 合并query和body</span>
    <span class="token keyword">const</span> body <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
    <span class="token keyword">const</span> query <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">;</span>
    req<span class="token punctuation">.</span>requestParams <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> body<span class="token punctuation">,</span> query<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 向客户端返回</span>
    <span class="token function">next</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>requestParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>最后，我们将<strong>自定义Handler</strong>挂载至<strong>ServiceCore</strong>并启动服务：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> serviceCore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Core<span class="token punctuation">.</span>ServiceCore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">serviceCore</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token punctuation">[</span>Handler<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
serviceCore<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>最后的最后，我们打开控制台，使用<code>curl http://localhost:3000/Test.do\?queryKey1\=queryValue1\&amp;queryKey2\=queryValue2 -d 'bodyKey1=bodyValue1&amp;bodyKey2=bodyValue2'</code>检查实现效果：</strong></p> <ul><li><p>客户端控制台将于请求发起后约<strong>1000ms</strong>打印请求处理结果。</p></li> <li><p>客户端收到的请求处理结果中将<strong>包含<code>query</code>和<code>body</code>中附带的参数</strong>。</p></li></ul> <h2 id="请求后处理"><a href="#请求后处理" class="header-anchor">#</a> 请求后处理</h2> <p>在<a href="#%E8%AF%B7%E6%B1%82%E9%A2%84%E5%A4%84%E7%90%86">请求预处理</a>阶段使用<a href="#%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6%E5%87%BD%E6%95%B0">流程控制函数</a>分发至下一处理阶段时，<strong>Handler</strong>将尝试调用<strong>与客户端请求方式匹配的实例方法</strong>进入<strong>请求后处理</strong>阶段。</p> <p><strong>我们通过重写Handler中与请求方式对应的实例方法以指定其请求后处理逻辑</strong>。比如，实现实例方法<code>postHandler</code>将指定客户端POST请求对应的后处理逻辑。</p> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p><strong>在进入请求后处理阶段时，如果Handler中没有实现与请求方式对应的实例方法，默认使用<code>defaultHandler</code>作为后处理逻辑。</strong></p> <p>默认的<code>defaultHandler</code>逻辑中，将直接使用<a href="#%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6%E5%87%BD%E6%95%B0">流程控制函数</a>执行<code>next(404)</code>向客户端返回404状态码。</p></div> <p>同样，<strong>Handler内置的异常捕获套件也将自动作用在<code>[METHOD]Handler</code>维度</strong>。即：<strong>全部请求方式对应的实例方法</strong>和<code>defaultHandler</code>执行过程中产生了未被捕获的异常时将自动进入<a href="#%E7%BB%9F%E4%B8%80%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">统一错误处理</a>。</p> <p>因此，我们应<strong>根据请求后处理中实际逻辑的同步或异步，选择使用<code>Function</code>或<code>AsyncFunction</code>类型的<code>[METHOD]Handler</code>。</strong></p> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p><strong>Handler内置的异常捕获机制仅在请求处理节点的根函数中产生未被捕获的异常时才产生效力。</strong></p> <p>因此，当<strong>请求后处理</strong>逻辑中包含异步任务时，我们<strong>可以使用<code>async/await</code>和<code>Promise</code>处理异步任务，以保证异常可以正常抛出。</strong></p></div> <blockquote><p><strong>通常，在请求后处理阶段首先应对客户端附带的参数进行有效性判断，驳回参数无效的客户端请求；在请求参数有效时，触发实际的业务处理。</strong></p></blockquote> <p><strong>需要注意的是，请求后处理阶段为请求处理链路的末端节点，通常应使用<a href="#%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6%E5%87%BD%E6%95%B0">流程控制函数</a>向客户端发起应答动作</strong>。另外，在<strong>请求后处理</strong>阶段执行<code>next()</code>时不会继续分发处理流程至下一阶段，而是进入<a href="#%E7%BB%9F%E4%B8%80%E5%AE%8C%E6%88%90%E5%A4%84%E7%90%86">统一完成处理</a>。</p> <hr> <p><strong>接下来，我们将实现一个支持客户端通过POST请求读取本地指定目录的Handler。</strong></p> <p><strong>对于只包含同步行为的请求后处理逻辑，我们使用<code>Function</code>类型的<code>postHandler</code>：</strong></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Handler</span> <span class="token keyword">extends</span> <span class="token class-name">Core<span class="token punctuation">.</span>Handler</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token function">getRoutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'/Test.do'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">postHandler</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> path <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// 同步读取目录内容并向客户端返回结果</span>
      <span class="token keyword">const</span> result <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">next</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 执行过程中产生异常时向客户端返回异常信息</span>
      <span class="token function">next</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>同样，<strong>当请求后处理逻辑中包含异步行为时，我们使用<code>AsyncFunction</code>类型的<code>postHandler</code>，并通过<code>await</code>关键字执行异步任务</strong>：</p> <div class="language-javascript line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br></div><pre class="language-javascript"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> promisify <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'util'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Handler</span> <span class="token keyword">extends</span> <span class="token class-name">Core<span class="token punctuation">.</span>Handler</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token function">getRoutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'/Test.do'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">postHandler</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> path <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">;</span>
    <span class="token comment">// 异步读取目录内容并向客户端返回结果</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">promisify</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span>readdir<span class="token punctuation">)</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 执行过程中产生异常时向客户端返回异常信息</span>
      <span class="token function">next</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result <span class="token operator">&amp;&amp;</span> <span class="token function">next</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>最后，我们将<strong>自定义Handler</strong>挂载至<strong>ServiceCore</strong>并启动服务：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> serviceCore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Core<span class="token punctuation">.</span>ServiceCore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">serviceCore</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token punctuation">[</span>Handler<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
serviceCore<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>最后的最后，我们打开控制台，使用<code>curl http://localhost:3000/Test.do\?path\=[本地目录绝对路径]</code>检查实现效果：</strong></p> <ul><li><p>当指定的<strong>本地目录绝对路径</strong>存在时，客户端收到的处理结果为<strong>本地目录中的内容</strong>。</p></li> <li><p>当未指定<strong>本地目录绝对路径</strong>或<strong>本地目录绝对路径</strong>不存在时，客户端收到的处理结果为<strong>异常原因</strong>。</p></li></ul> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p><strong>样例代码中使用的异常处理方式不推荐在实际业务代码中使用</strong>。对于如何优雅的处理异常，我们将在<a href="#%E7%BB%9F%E4%B8%80%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">统一错误处理</a>中进行详细讨论。</p></div> <h2 id="统一完成处理"><a href="#统一完成处理" class="header-anchor">#</a> 统一完成处理</h2> <p>在<strong>任意请求处理阶段</strong>中使用<a href="#%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6%E5%87%BD%E6%95%B0">流程控制函数</a>执行<code>next(data)</code>时将触发<strong>统一完成处理</strong>。</p> <p><strong>我们通过重写Handler的实例方法<code>onFinish()</code>以指定统一完成处理阶段执行的逻辑。</strong></p> <div class="custom-block tip"><p class="custom-block-title">说明</p> <p><strong>我们通常在统一完成处理阶段完成对客户端返回内容的统一结构组装，并操作客户端返回实例<code>res</code>向客户端返回处理结果。</strong></p> <p>需要注意的是，直接操作<strong>客户端返回实例</strong><code>res</code>发起返回动作将跳过<strong>统一完成处理</strong>阶段直接触发<a href="#handler%E6%9E%90%E6%9E%84">Handler析构</a>。</p> <p>因此，<strong>我们在请求处理过程中期望向客户端返回处理结果时应使用<a href="#%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6%E5%87%BD%E6%95%B0">流程控制函数</a>，而不是直接操作客户端返回实例<code>res</code></strong>。</p></div> <p>同样，<strong>Handler内置的异常捕获套件也将自动作用在实例方法<code>onFinish</code>维度</strong>。即：当<code>onFinish</code>执行过程中产生了未被捕获的异常时将自动进入<a href="#%E7%BB%9F%E4%B8%80%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">统一错误处理</a>。</p> <p>因此，我们应<strong>根据请求预处理中实际逻辑的同步或异步，选择使用<code>Function</code>或<code>AsyncFunction</code>类型的<code>onFinish</code>。</strong></p> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p><strong>Handler内置的异常捕获机制仅在请求处理节点的根函数中产生未被捕获的异常时才产生效力。</strong></p> <p>因此，当<strong>统一完成处理</strong>逻辑中包含异步任务时，我们<strong>可以使用<code>async/await</code>和<code>Promise</code>处理异步任务，以保证异常可以正常抛出。</strong></p></div> <hr> <p><strong>接下来，我们将完善请求后处理中的🌰，为其向客户端的返回内容添加统一结构。</strong></p> <p>首先，创建一个用于<strong>模拟耗时同步和异步任务</strong>的<code>BaseHandler</code>作为基类：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">BaseHandler</span> <span class="token keyword">extends</span> <span class="token class-name">Core<span class="token punctuation">.</span>Handler</span> <span class="token punctuation">{</span>
  <span class="token comment">// 异步耗时任务</span>
  <span class="token function">asyncTask</span><span class="token punctuation">(</span><span class="token parameter">duration <span class="token operator">=</span> <span class="token number">0</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> duration<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 同步耗时任务</span>
  <span class="token function">syncTask</span><span class="token punctuation">(</span><span class="token parameter">duration <span class="token operator">=</span> <span class="token number">0</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> startDate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> startDate<span class="token punctuation">)</span> <span class="token operator">&gt;</span> duration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">提示</p> <p><strong>通常，我们不需要完全重写<code>onFinish</code>中包含的逻辑，而是使用<code>super.onFinish()</code>复用默认的统一完成处理逻辑。</strong></p> <p>对于<strong>统一完成处理</strong>默认支持的行为，我们可以参考<a href="#%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6%E5%87%BD%E6%95%B0">流程控制函数</a>。</p></div> <p>接下来，我们将<strong>自定义Handler</strong>继承的基类变更为<code>BaseHandler</code>，并在<strong>统一完成处理</strong>中完成报文结构包装：</p> <p><strong>对于只包含同步行为的请求预处理逻辑，我们使用<code>Function</code>类型的<code>onFinish</code>：</strong></p> <div class="language-javascript line-numbers-mode"><div class="highlight-lines"><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br></div><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">Handler</span> <span class="token keyword">extends</span> <span class="token class-name">BaseHandler</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token function">getRoutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'/Test.do'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">postHandler</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> path <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// 同步读取目录内容并向客户端返回结果</span>
      <span class="token keyword">const</span> result <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">next</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 执行过程中产生异常时向客户端返回异常信息</span>
      <span class="token function">next</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">onFinish</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 执行1000ms的同步任务</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">syncTask</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 构造报文结构并执行原始的onFinish()方法向客户端返回</span>
    <span class="token keyword">const</span> backMessage <span class="token operator">=</span> <span class="token punctuation">{</span> code<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> data <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onFinish</span><span class="token punctuation">(</span>backMessage<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>同样，<strong>当请求后处理逻辑中包含异步行为时，我们使用<code>AsyncFunction</code>类型的<code>onFinish</code>，并通过<code>await</code>关键字执行异步任务</strong>：</p> <div class="language-javascript line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br></div><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">Handler</span> <span class="token keyword">extends</span> <span class="token class-name">BaseHandler</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token function">getRoutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'/Test.do'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">postHandler</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> path <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">;</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">promisify</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span>readdir<span class="token punctuation">)</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">next</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result <span class="token operator">&amp;&amp;</span> <span class="token function">next</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">onFinish</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 执行1000ms的异步任务</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">asyncTask</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 构造报文结构并执行原始的onFinish()方法向客户端返回</span>
    <span class="token keyword">const</span> backMessage <span class="token operator">=</span> <span class="token punctuation">{</span> code<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> data <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onFinish</span><span class="token punctuation">(</span>backMessage<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p><strong>最后，我们打开控制台，使用<code>curl http://localhost:3000/Test.do\?path\=[本地目录绝对路径]</code>检查实现效果：</strong></p> <ul><li><p>客户端控制台将于请求发起后约<strong>1000ms</strong>打印请求处理结果，且处理结果拥有统一的结构<code>{ code: 0, data: [处理结果] }</code>。</p></li> <li><p>当指定的<strong>本地目录绝对路径</strong>存在时，客户端收到的处理结果为<strong>本地目录中的内容</strong>。</p></li> <li><p>当未指定<strong>本地目录绝对路径</strong>或<strong>本地目录绝对路径</strong>不存在时，客户端收到的处理结果为<strong>异常原因</strong>。</p></li></ul> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p><strong>样例代码中使用的异常处理方式不推荐在实际业务代码中使用</strong>。对于如何优雅的处理异常，我们将在<a href="#%E7%BB%9F%E4%B8%80%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">统一错误处理</a>中进行详细讨论。</p></div> <h2 id="统一错误处理"><a href="#统一错误处理" class="header-anchor">#</a> 统一错误处理</h2> <p><strong>任意请求处理阶段</strong>的根函数中产生未被捕获的异常时，<strong>Handler</strong>将自动引导处理流程进入<strong>统一完成处理</strong>阶段。</p> <p>另外，我们可以在<strong>请求处理任意阶段</strong>中使用<a href="#%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6%E5%87%BD%E6%95%B0">流程控制函数</a>执行<code>next(error)</code>手动触发<strong>统一完成处理</strong>。</p> <p><strong>我们通过重写Handler的实例方法<code>onError</code>以指定统一完成处理阶段执行的逻辑。</strong></p> <div class="custom-block tip"><p class="custom-block-title">说明</p> <p><strong>我们通常在统一错误处理阶段处理异常后，直接操作客户端返回实例<code>res</code>向客户端返回处理结果。</strong></p></div> <p>同样，<strong>Handler内置的异常捕获套件也将自动作用在实例方法<code>onError</code>维度</strong>。与其他处理阶段不同的是，<strong>当<code>onError</code>执行过程中产生了未被捕获的异常时将进入ServiceCore的<a href="/guide/web-service.html#错误拦截器">错误拦截器</a>。</strong></p> <p>因此，我们应<strong>根据请求预处理中实际逻辑的同步或异步，选择使用<code>Function</code>或<code>AsyncFunction</code>类型的<code>onFinish</code>。</strong></p> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p><strong>Handler内置的异常捕获机制仅在请求处理节点的根函数中产生未被捕获的异常时才产生效力。</strong></p> <p>因此，当<strong>统一错误处理</strong>逻辑中包含异步任务时，我们<strong>可以使用<code>async/await</code>和<code>Promise</code>处理异步任务，以保证异常可以正常抛出。</strong></p></div> <hr> <p><strong>接下来，我们将使用更优雅的异常处理方案来完善请求后处理中的🌰。</strong></p> <p>首先，创建一个用于<strong>模拟耗时同步和异步任务</strong>的<code>BaseHandler</code>作为基类：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">BaseHandler</span> <span class="token keyword">extends</span> <span class="token class-name">Core<span class="token punctuation">.</span>Handler</span> <span class="token punctuation">{</span>
  <span class="token comment">// 异步耗时任务</span>
  <span class="token function">asyncTask</span><span class="token punctuation">(</span><span class="token parameter">duration <span class="token operator">=</span> <span class="token number">0</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> duration<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 同步耗时任务</span>
  <span class="token function">syncTask</span><span class="token punctuation">(</span><span class="token parameter">duration <span class="token operator">=</span> <span class="token number">0</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> startDate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> startDate<span class="token punctuation">)</span> <span class="token operator">&gt;</span> duration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>接下来，我们将<strong>自定义Handler</strong>继承的基类变更为<code>BaseHandler</code>，删除<strong>Handler后处理</strong>中异常处理相关的代码，并在<strong>统一错误处理</strong>中收口异常处理：</p> <p><strong>对于只包含同步行为的请求预处理逻辑，我们使用<code>Function</code>类型的<code>onError</code>：</strong></p> <div class="language-javascript line-numbers-mode"><div class="highlight-lines"><div class="highlighted"> </div><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br></div><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">Handler</span> <span class="token keyword">extends</span> <span class="token class-name">BaseHandler</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token function">getRoutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'/Test.do'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">postHandler</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> path <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">;</span>
    <span class="token comment">// 同步读取目录内容并向客户端返回结果</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">onError</span><span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 执行1000ms的同步任务</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">syncTask</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 向客户端返回异常信息</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>同样，<strong>当请求后处理逻辑中包含异步行为时，我们使用<code>AsyncFunction</code>类型的<code>onError</code>，并通过<code>await</code>关键字执行异步任务</strong>：</p> <div class="language-javascript line-numbers-mode"><div class="highlight-lines"><div class="highlighted"> </div><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br></div><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">Handler</span> <span class="token keyword">extends</span> <span class="token class-name">BaseHandler</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token function">getRoutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'/Test.do'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">postHandler</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> path <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">;</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">promisify</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span>readdir<span class="token punctuation">)</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">onError</span><span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 执行1000ms的异步任务</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">asyncTask</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 向客户端返回异常信息</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p><strong>最后，我们打开控制台，使用<code>curl http://localhost:3000/Test.do\?path\=[不存在的本地目录绝对路径]</code>检查实现效果：</strong></p> <ul><li>客户端控制台将于请求发起后约<strong>1000ms</strong>打印请求处理结果，处理结果为<strong>异常原因</strong>。</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/guide/web-service.html" class="prev">
        Web服务
      </a></span> <span class="next"><a href="/guide/log-collectting.html">
        日志收集
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.3dfa1ee5.js" defer></script><script src="/assets/js/2.6fef8c05.js" defer></script><script src="/assets/js/18.cc2998e3.js" defer></script>
  </body>
</html>
